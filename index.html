<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BonusDrivingSchool - Enhanced CMS</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for Excel import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <!-- FullCalendar for scheduling -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <style>
        /* Custom scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #dc2626;
            border-radius: 3px;
        }
        .sidebar {
            transition: all 0.3s ease;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
        }
        .fc-event {
            cursor: pointer;
        }
        .print-only {
            display: none;
        }
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            body {
                background: white !important;
                color: black !important;
            }
            .print-break {
                page-break-after: always;
            }
        }
    </style>
</head>
<body class="bg-white text-gray-900">
    <!-- Authentication Views -->
    <div id="auth-views" class="min-h-screen flex items-center justify-center bg-gray-50">
        <!-- Login View -->
        <div id="login-view" class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <h2 class="text-2xl font-bold text-center mb-6 text-red-600">BonusDrivingSchool</h2>
            <h3 class="text-xl font-semibold text-center mb-6">Login</h3>
            <form id="login-form">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="login-email">
                        Email
                    </label>
                    <input id="login-email" type="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="login-password">
                        Password
                    </label>
                    <input id="login-password" type="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                        Sign In
                    </button>
                </div>
            </form>
            <p class="text-center text-gray-600 text-xs mt-4">
                Don't have an account? 
                <a href="#" id="show-register" class="text-red-600 font-bold">Register here</a>
            </p>
            <div id="login-error" class="mt-4 text-red-600 text-center hidden"></div>
        </div>

        <!-- Registration View -->
        <div id="register-view" class="bg-white p-8 rounded-lg shadow-md w-full max-w-md hidden">
            <h2 class="text-2xl font-bold text-center mb-6 text-red-600">BonusDrivingSchool</h2>
            <h3 class="text-xl font-semibold text-center mb-6">Registration</h3>
            <form id="register-form">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="register-email">
                        Email
                    </label>
                    <input id="register-email" type="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="register-password">
                        Password
                    </label>
                    <input id="register-password" type="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="register-role">
                        Role
                    </label>
                    <select id="register-role" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="instructor">Instructor</option>
                        <option value="admin" disabled>Admin (requires approval)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Self-registered users default to Instructor role. Contact an admin for Admin access.</p>
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                        Register
                    </button>
                </div>
            </form>
            <p class="text-center text-gray-600 text-xs mt-4">
                Already have an account? 
                <a href="#" id="show-login" class="text-red-600 font-bold">Sign in here</a>
            </p>
            <div id="register-error" class="mt-4 text-red-600 text-center hidden"></div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="hidden">
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-button" class="md:hidden fixed top-4 left-4 z-50 bg-red-600 text-white p-2 rounded no-print">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>

        <!-- Sidebar Navigation -->
        <div class="sidebar fixed inset-y-0 left-0 z-40 w-64 bg-gray-900 text-white transform md:translate-x-0 no-print">
            <div class="flex items-center justify-center h-16 bg-red-600">
                <h1 class="text-xl font-bold">BonusDrivingSchool</h1>
            </div>
            <div class="p-4 border-b border-gray-700">
                <p class="text-sm">Welcome, <span id="user-name" class="font-semibold"></span></p>
                <p class="text-xs text-gray-400">Role: <span id="user-role" class="font-semibold"></span></p>
            </div>
            <nav class="mt-4">
                <ul>
                    <li class="mb-2 admin-only">
                        <a href="#" class="nav-link block py-2 px-4 hover:bg-gray-800" data-tab="dashboard">
                            <span class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                </svg>
                                Dashboard
                            </span>
                        </a>
                    </li>
                    <li class="mb-2 admin-only">
                        <a href="#" class="nav-link block py-2 px-4 hover:bg-gray-800" data-tab="clients">
                            <span class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                </svg>
                                Client Management
                            </span>
                        </a>
                    </li>
                    <li class="mb-2 admin-only">
                        <a href="#" class="nav-link block py-2 px-4 hover:bg-gray-800" data-tab="payments">
                            <span class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                                Payment Management
                            </span>
                        </a>
                    </li>
                    <li class="mb-2 admin-only">
                        <a href="#" class="nav-link block py-2 px-4 hover:bg-gray-800" data-tab="instructors">
                            <span class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                Instructor Management
                            </span>
                        </a>
                    </li>
                    <li class="mb-2 admin-only">
                        <a href="#" class="nav-link block py-2 px-4 hover:bg-gray-800" data-tab="vehicles">
                            <span class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                                </svg>
                                Vehicle Management
                            </span>
                        </a>
                    </li>
                    <li class="mb-2 admin-only">
                        <a href="#" class="nav-link block py-2 px-4 hover:bg-gray-800" data-tab="scheduling">
                            <span class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                Scheduling
                            </span>
                        </a>
                    </li>
                    <li class="mb-2 instructor-only">
                        <a href="#" class="nav-link block py-2 px-4 hover:bg-gray-800" data-tab="my-schedule">
                            <span class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                My Schedule
                            </span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="#" class="nav-link block py-2 px-4 hover:bg-gray-800" data-tab="import">
                            <span class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                </svg>
                                Excel Import
                            </span>
                        </a>
                    </li>
                    <li class="mt-8">
                        <a href="#" id="logout-button" class="block py-2 px-4 hover:bg-gray-800 text-red-400">
                            <span class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                </svg>
                                Logout
                            </span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="md:ml-64 min-h-screen">
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content p-6 admin-only">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-red-600">
                        <h3 class="text-lg font-semibold text-gray-700">Total Clients</h3>
                        <p id="total-clients" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-red-600">
                        <h3 class="text-lg font-semibold text-gray-700">Active Clients</h3>
                        <p id="active-clients" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-red-600">
                        <h3 class="text-lg font-semibold text-gray-700">Total Revenue</h3>
                        <p id="total-revenue" class="text-3xl font-bold text-gray-900 mt-2">R 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-red-600">
                        <h3 class="text-lg font-semibold text-gray-700">Pending Payments</h3>
                        <p id="pending-payments" class="text-3xl font-bold text-gray-900 mt-2">R 0</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Recent Clients</h3>
                        <div id="recent-clients" class="overflow-y-auto max-h-80">
                            <!-- Recent clients will be populated here -->
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Recent Payments</h3>
                        <div id="recent-payments" class="overflow-y-auto max-h-80">
                            <!-- Recent payments will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Client Management Tab -->
            <div id="clients-tab" class="tab-content p-6 hidden admin-only">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Client Management</h2>
                
                <!-- Client Form -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800" id="client-form-title">Add New Client</h3>
                    <form id="client-form">
                        <input type="hidden" id="client-id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-name">
                                    Name *
                                </label>
                                <input id="client-name" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-surname">
                                    Surname *
                                </label>
                                <input id="client-surname" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-email">
                                    Email Address
                                </label>
                                <input id="client-email" type="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <p id="client-email-error" class="text-red-500 text-xs mt-1 hidden">Please enter a valid email address</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-phone">
                                    Phone Number *
                                </label>
                                <input id="client-phone" type="tel" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                                <p id="client-phone-error" class="text-red-500 text-xs mt-1 hidden">Please enter a valid phone number</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-mom-phone">
                                    Mom's Number
                                </label>
                                <input id="client-mom-phone" type="tel" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-dad-phone">
                                    Dad's Number
                                </label>
                                <input id="client-dad-phone" type="tel" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-id-number">
                                    ID Number
                                </label>
                                <input id="client-id-number" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <p id="client-id-error" class="text-red-500 text-xs mt-1 hidden">Please enter a valid ID number</p>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-status">
                                    Status
                                </label>
                                <select id="client-status" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-learners-code">
                                    Learner's Code
                                </label>
                                <select id="client-learners-code" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-license-code">
                                    License Code
                                </label>
                                <select id="client-license-code" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="EB">EB</option>
                                    <option value="C">C</option>
                                    <option value="EC">EC</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-course-fee">
                                    Total Course Fee (R)
                                </label>
                                <input id="client-course-fee" type="number" step="0.01" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button type="button" id="cancel-client" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2">
                                Cancel
                            </button>
                            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                                Save Client
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Client Search and Filters -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Search & Filter Clients</h3>
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <input id="client-search" type="text" placeholder="Search by name, email, phone, or ID..." class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <button id="search-clients" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded whitespace-nowrap">
                            Search
                        </button>
                        <button id="clear-search" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded whitespace-nowrap">
                            Clear
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="filter-status">
                                Filter by Status
                            </label>
                            <select id="filter-status" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="all">All Statuses</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="sort-by">
                                Sort By
                            </label>
                            <select id="sort-by" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="name">Name</option>
                                <option value="registrationDate">Registration Date</option>
                                <option value="status">Status</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="sort-order">
                                Sort Order
                            </label>
                            <select id="sort-order" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="asc">Ascending</option>
                                <option value="desc">Descending</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Client List -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Client List</h3>
                    <div id="client-list" class="overflow-x-auto">
                        <!-- Client list will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Payment Management Tab -->
            <div id="payments-tab" class="tab-content p-6 hidden admin-only">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Payment Management</h2>
                
                <!-- Payment Form -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800" id="payment-form-title">Add New Payment</h3>
                    <form id="payment-form">
                        <input type="hidden" id="payment-id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="payment-client">
                                    Client *
                                </label>
                                <select id="payment-client" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                                    <option value="">Select a client</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="payment-date">
                                    Payment Date *
                                </label>
                                <input id="payment-date" type="date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="payment-amount">
                                    Amount Paid *
                                </label>
                                <input id="payment-amount" type="number" step="0.01" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="payment-method">
                                    Payment Method *
                                </label>
                                <select id="payment-method" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                                    <option value="Cash">Cash</option>
                                    <option value="EFT">EFT</option>
                                    <option value="Card">Card</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button type="button" id="cancel-payment" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2">
                                Cancel
                            </button>
                            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                                Save Payment
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Financial Summary -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Financial Summary</h3>
                    <div id="financial-summary" class="overflow-x-auto">
                        <!-- Financial summary will be populated here -->
                    </div>
                </div>

                <!-- All Payments List -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">All Payments</h3>
                    <div id="payment-list" class="overflow-x-auto">
                        <!-- Payment list will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Instructor Management Tab -->
            <div id="instructors-tab" class="tab-content p-6 hidden admin-only">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Instructor Management</h2>
                
                <!-- Instructor Form -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800" id="instructor-form-title">Add New Instructor</h3>
                    <form id="instructor-form">
                        <input type="hidden" id="instructor-id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="instructor-name">
                                    Name *
                                </label>
                                <input id="instructor-name" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="instructor-surname">
                                    Surname *
                                </label>
                                <input id="instructor-surname" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="instructor-email">
                                    Email Address *
                                </label>
                                <input id="instructor-email" type="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="instructor-phone">
                                    Phone Number *
                                </label>
                                <input id="instructor-phone" type="tel" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="instructor-calendar-id">
                                    Google Calendar ID
                                </label>
                                <input id="instructor-calendar-id" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="e.g., example@gmail.com">
                                <p class="text-xs text-gray-500 mt-1">Enter the Google Calendar email address to sync lessons with the instructor's calendar</p>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button type="button" id="cancel-instructor" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2">
                                Cancel
                            </button>
                            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                                Save Instructor
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Instructor List -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Instructor List</h3>
                    <div id="instructor-list" class="overflow-x-auto">
                        <!-- Instructor list will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Vehicle Management Tab -->
            <div id="vehicles-tab" class="tab-content p-6 hidden admin-only">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Vehicle Management</h2>
                
                <!-- Vehicle Form -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800" id="vehicle-form-title">Add New Vehicle</h3>
                    <form id="vehicle-form">
                        <input type="hidden" id="vehicle-id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="vehicle-make">
                                    Make *
                                </label>
                                <input id="vehicle-make" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="vehicle-model">
                                    Model *
                                </label>
                                <input id="vehicle-model" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="vehicle-year">
                                    Year
                                </label>
                                <input id="vehicle-year" type="number" min="1990" max="2030" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="vehicle-license">
                                    License Plate *
                                </label>
                                <input id="vehicle-license" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="vehicle-status">
                                    Status
                                </label>
                                <select id="vehicle-status" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="Available">Available</option>
                                    <option value="In Use">In Use</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Out of Service">Out of Service</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button type="button" id="cancel-vehicle" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2">
                                Cancel
                            </button>
                            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                                Save Vehicle
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Vehicle List -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Vehicle List</h3>
                    <div id="vehicle-list" class="overflow-x-auto">
                        <!-- Vehicle list will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Scheduling Tab -->
            <div id="scheduling-tab" class="tab-content p-6 hidden admin-only">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Scheduling</h2>
                
                <!-- Lesson Form -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800" id="lesson-form-title">Schedule New Lesson</h3>
                    <form id="lesson-form">
                        <input type="hidden" id="lesson-id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="lesson-client">
                                    Client *
                                </label>
                                <select id="lesson-client" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                                    <option value="">Select a client</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="lesson-instructor">
                                    Instructor *
                                </label>
                                <select id="lesson-instructor" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                                    <option value="">Select an instructor</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="lesson-vehicle">
                                    Vehicle
                                </label>
                                <select id="lesson-vehicle" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="">Select a vehicle</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="lesson-type">
                                    Lesson Type *
                                </label>
                                <select id="lesson-type" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                                    <option value="Driving Practice">Driving Practice</option>
                                    <option value="Theory Lesson">Theory Lesson</option>
                                    <option value="Road Test Prep">Road Test Prep</option>
                                    <option value="Assessment">Assessment</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="lesson-date">
                                    Date *
                                </label>
                                <input id="lesson-date" type="date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="lesson-time">
                                    Time *
                                </label>
                                <input id="lesson-time" type="time" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="lesson-duration">
                                    Duration (minutes) *
                                </label>
                                <input id="lesson-duration" type="number" min="30" step="30" value="60" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="lesson-notes">
                                    Notes / Progress
                                </label>
                                <textarea id="lesson-notes" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button type="button" id="cancel-lesson" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2">
                                Cancel
                            </button>
                            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                                Schedule Lesson
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Master Calendar -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Master Calendar</h3>
                    <div id="calendar" class="overflow-x-auto"></div>
                </div>
            </div>

            <!-- My Schedule Tab (Instructor View) -->
            <div id="my-schedule-tab" class="tab-content p-6 hidden instructor-only">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">My Schedule</h2>
                
                <!-- Instructor's Personal Calendar -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">My Lessons</h3>
                    <div id="instructor-calendar" class="overflow-x-auto"></div>
                </div>

                <!-- Lesson Progress Update Form -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Update Lesson Progress</h3>
                    <div id="instructor-lessons" class="overflow-x-auto">
                        <!-- Instructor's lessons will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Excel Import Tab -->
            <div id="import-tab" class="tab-content p-6 hidden admin-only">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Excel Import Utility</h2>
                
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Import Data</h3>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="import-type">
                            Import Type
                        </label>
                        <select id="import-type" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="clients">Client Records</option>
                            <option value="payments">Payment Records</option>
                            <option value="instructors">Instructor Records</option>
                            <option value="vehicles">Vehicle Records</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="excel-file">
                            Excel File (.xlsx, .xls)
                        </label>
                        <input id="excel-file" type="file" accept=".xlsx, .xls" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="flex justify-end">
                        <button id="import-data" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                            Import Data
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Import Results</h3>
                    <div id="import-results" class="overflow-x-auto">
                        <!-- Import results will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Detail Modal -->
    <div id="client-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden no-print">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Client Details</h3>
                    <div>
                        <button id="print-client" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-2">
                            Print Profile
                        </button>
                        <button id="close-client-modal" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="client-detail-content">
                    <!-- Client details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Print View for Client Profile -->
    <div id="client-print-view" class="hidden print-only">
        <!-- Client print content will be populated here -->
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden no-print">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4" id="confirmation-title">Confirm Action</h3>
                <p class="text-gray-600 mb-6" id="confirmation-message">Are you sure you want to perform this action?</p>
                <div class="flex justify-end">
                    <button id="confirm-cancel" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2">
                        Cancel
                    </button>
                    <button id="confirm-action" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lesson Detail Modal -->
    <div id="lesson-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden no-print">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Lesson Details</h3>
                    <button id="close-lesson-modal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="lesson-detail-content">
                    <!-- Lesson details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            doc, 
            onSnapshot, 
            serverTimestamp,
            query,
            orderBy,
            where
        } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA-8qCiQbDjgIJz8cJHjbo5dajOm70QKpU",
            authDomain: "bonus-cms.firebaseapp.com",
            projectId: "bonus-cms",
            storageBucket: "bonus-cms.firebasestorage.app",
            messagingSenderId: "217665267949",
            appId: "1:217665267949:web:6279faf663b954c60104e4",
            measurementId: "G-1LTR20E5RN"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Application state
        let currentUser = null;
        let currentUserRole = null;
        let clients = [];
        let payments = [];
        let instructors = [];
        let vehicles = [];
        let lessons = [];
        let editingClientId = null;
        let editingPaymentId = null;
        let editingInstructorId = null;
        let editingVehicleId = null;
        let editingLessonId = null;
        let confirmationCallback = null;

        // DOM Elements
        const authViews = document.getElementById('auth-views');
        const mainApp = document.getElementById('main-app');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegister = document.getElementById('show-register');
        const showLogin = document.getElementById('show-login');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');
        const logoutButton = document.getElementById('logout-button');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const sidebar = document.querySelector('.sidebar');
        const navLinks = document.querySelectorAll('.nav-link');
        const tabContents = document.querySelectorAll('.tab-content');
        const adminOnlyElements = document.querySelectorAll('.admin-only');
        const instructorOnlyElements = document.querySelectorAll('.instructor-only');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date for forms
            document.getElementById('payment-date').valueAsDate = new Date();
            document.getElementById('lesson-date').valueAsDate = new Date();
            
            // Authentication state observer
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    // Get user role from Firestore
                    await loadUserRole();
                    authViews.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    updateUIForRole();
                    loadData();
                } else {
                    currentUser = null;
                    currentUserRole = null;
                    authViews.classList.remove('hidden');
                    mainApp.classList.add('hidden');
                    showLoginView();
                }
            });

            // Event listeners for authentication
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            showRegister.addEventListener('click', showRegisterView);
            showLogin.addEventListener('click', showLoginView);
            logoutButton.addEventListener('click', handleLogout);

            // Event listeners for navigation
            mobileMenuButton.addEventListener('click', toggleMobileMenu);
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tab = this.getAttribute('data-tab');
                    showTab(tab);
                    if (window.innerWidth < 768) {
                        sidebar.classList.remove('active');
                    }
                });
            });

            // Event listeners for client management
            document.getElementById('client-form').addEventListener('submit', handleClientSubmit);
            document.getElementById('cancel-client').addEventListener('click', resetClientForm);
            document.getElementById('search-clients').addEventListener('click', searchClients);
            document.getElementById('clear-search').addEventListener('click', clearSearch);
            document.getElementById('filter-status').addEventListener('change', filterAndSortClients);
            document.getElementById('sort-by').addEventListener('change', filterAndSortClients);
            document.getElementById('sort-order').addEventListener('change', filterAndSortClients);

            // Event listeners for payment management
            document.getElementById('payment-form').addEventListener('submit', handlePaymentSubmit);
            document.getElementById('cancel-payment').addEventListener('click', resetPaymentForm);

            // Event listeners for instructor management
            document.getElementById('instructor-form').addEventListener('submit', handleInstructorSubmit);
            document.getElementById('cancel-instructor').addEventListener('click', resetInstructorForm);

            // Event listeners for vehicle management
            document.getElementById('vehicle-form').addEventListener('submit', handleVehicleSubmit);
            document.getElementById('cancel-vehicle').addEventListener('click', resetVehicleForm);

            // Event listeners for scheduling
            document.getElementById('lesson-form').addEventListener('submit', handleLessonSubmit);
            document.getElementById('cancel-lesson').addEventListener('click', resetLessonForm);

            // Event listeners for import
            document.getElementById('import-data').addEventListener('click', handleImport);

            // Event listeners for modals
            document.getElementById('close-client-modal').addEventListener('click', closeClientModal);
            document.getElementById('print-client').addEventListener('click', printClientProfile);
            document.getElementById('close-lesson-modal').addEventListener('click', closeLessonModal);
            document.getElementById('confirm-cancel').addEventListener('click', closeConfirmationModal);
            document.getElementById('confirm-action').addEventListener('click', executeConfirmedAction);

            // Initialize with appropriate tab based on role
            showTab(currentUserRole === 'admin' ? 'dashboard' : 'my-schedule');
        });

        // Authentication functions
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            signInWithEmailAndPassword(auth, email, password)
                .then(() => {
                    // Login successful, handled by auth state observer
                })
                .catch(error => {
                    loginError.textContent = error.message;
                    loginError.classList.remove('hidden');
                });
        }

        function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const role = document.getElementById('register-role').value;

            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Store user role in Firestore
                    return addDoc(collection(db, 'users'), {
                        uid: userCredential.user.uid,
                        email: email,
                        role: role,
                        createdAt: serverTimestamp()
                    });
                })
                .then(() => {
                    // Registration successful, handled by auth state observer
                })
                .catch(error => {
                    registerError.textContent = error.message;
                    registerError.classList.remove('hidden');
                });
        }

        function showLoginView() {
            loginView.classList.remove('hidden');
            registerView.classList.add('hidden');
            loginError.classList.add('hidden');
        }

        function showRegisterView() {
            loginView.classList.add('hidden');
            registerView.classList.remove('hidden');
            registerError.classList.add('hidden');
        }

        function handleLogout() {
            signOut(auth);
        }

        async function loadUserRole() {
            if (!currentUser) return;
            
            const q = query(collection(db, 'users'), where('uid', '==', currentUser.uid));
            const querySnapshot = await getDocs(q);
            
            if (!querySnapshot.empty) {
                const userDoc = querySnapshot.docs[0];
                currentUserRole = userDoc.data().role;
                document.getElementById('user-name').textContent = currentUser.email;
                document.getElementById('user-role').textContent = currentUserRole === 'admin' ? 'Admin' : 'Instructor';
            } else {
                // Default to instructor if no role found
                currentUserRole = 'instructor';
                document.getElementById('user-name').textContent = currentUser.email;
                document.getElementById('user-role').textContent = 'Instructor';
            }
        }

        function updateUIForRole() {
            if (currentUserRole === 'admin') {
                adminOnlyElements.forEach(el => el.style.display = 'block');
                instructorOnlyElements.forEach(el => el.style.display = 'none');
            } else {
                adminOnlyElements.forEach(el => el.style.display = 'none');
                instructorOnlyElements.forEach(el => el.style.display = 'block');
            }
        }

        // Navigation functions
        function toggleMobileMenu() {
            sidebar.classList.toggle('active');
        }

        function showTab(tabName) {
            // Hide all tab contents
            tabContents.forEach(tab => {
                tab.classList.add('hidden');
            });

            // Remove active class from all nav links
            navLinks.forEach(link => {
                link.classList.remove('bg-gray-800');
            });

            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');

            // Add active class to selected nav link
            const selectedLink = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedLink) {
                selectedLink.classList.add('bg-gray-800');
            }

            // Load specific data if needed
            if (tabName === 'payments' || tabName === 'scheduling') {
                loadClientsForSelect();
            }
            if (tabName === 'scheduling') {
                loadInstructorsForSelect();
                loadVehiclesForSelect();
                initializeCalendar();
            }
            if (tabName === 'my-schedule') {
                initializeInstructorCalendar();
                loadInstructorLessons();
            }
        }

        // Data management functions
        function loadData() {
            loadClients();
            loadPayments();
            loadInstructors();
            loadVehicles();
            loadLessons();
        }

        function loadClients() {
            const q = query(collection(db, 'clients'), orderBy('registrationDate', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                clients = [];
                snapshot.forEach((doc) => {
                    clients.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                updateClientList();
                updateDashboard();
            });
        }

        function loadPayments() {
            const q = query(collection(db, 'payments'), orderBy('date', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                payments = [];
                snapshot.forEach((doc) => {
                    payments.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                updatePaymentList();
                updateFinancialSummary();
                updateDashboard();
            });
        }

        function loadInstructors() {
            const q = query(collection(db, 'instructors'), orderBy('name'));
            
            onSnapshot(q, (snapshot) => {
                instructors = [];
                snapshot.forEach((doc) => {
                    instructors.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                updateInstructorList();
            });
        }

        function loadVehicles() {
            const q = query(collection(db, 'vehicles'), orderBy('make'));
            
            onSnapshot(q, (snapshot) => {
                vehicles = [];
                snapshot.forEach((doc) => {
                    vehicles.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                updateVehicleList();
            });
        }

        function loadLessons() {
            const q = query(collection(db, 'lessons'), orderBy('date'));
            
            onSnapshot(q, (snapshot) => {
                lessons = [];
                snapshot.forEach((doc) => {
                    lessons.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                updateCalendar();
            });
        }

        function loadClientsForSelect() {
            const clientSelects = document.querySelectorAll('#payment-client, #lesson-client');
            clientSelects.forEach(select => {
                select.innerHTML = '<option value="">Select a client</option>';
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.name} ${client.surname}`;
                    select.appendChild(option);
                });
            });
        }

        function loadInstructorsForSelect() {
            const instructorSelect = document.getElementById('lesson-instructor');
            instructorSelect.innerHTML = '<option value="">Select an instructor</option>';
            instructors.forEach(instructor => {
                const option = document.createElement('option');
                option.value = instructor.id;
                option.textContent = `${instructor.name} ${instructor.surname}`;
                instructorSelect.appendChild(option);
            });
        }

        function loadVehiclesForSelect() {
            const vehicleSelect = document.getElementById('lesson-vehicle');
            vehicleSelect.innerHTML = '<option value="">Select a vehicle</option>';
            vehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle.id;
                option.textContent = `${vehicle.make} ${vehicle.model} (${vehicle.licensePlate})`;
                option.disabled = vehicle.status !== 'Available';
                select.appendChild(option);
            });
        }

        // Client management functions
        function handleClientSubmit(e) {
            e.preventDefault();
            
            // Validate form
            if (!validateClientForm()) {
                return;
            }
            
            const clientData = {
                name: document.getElementById('client-name').value,
                surname: document.getElementById('client-surname').value,
                email: document.getElementById('client-email').value,
                phone: document.getElementById('client-phone').value,
                momPhone: document.getElementById('client-mom-phone').value,
                dadPhone: document.getElementById('client-dad-phone').value,
                idNumber: document.getElementById('client-id-number').value,
                status: document.getElementById('client-status').value,
                learnersCode: document.getElementById('client-learners-code').value,
                licenseCode: document.getElementById('client-license-code').value,
                courseFee: parseFloat(document.getElementById('client-course-fee').value) || 0
            };

            if (editingClientId) {
                // Update existing client
                updateDoc(doc(db, 'clients', editingClientId), clientData)
                    .then(() => {
                        resetClientForm();
                    })
                    .catch(error => {
                        console.error('Error updating client: ', error);
                    });
            } else {
                // Add new client
                clientData.registrationDate = serverTimestamp();
                
                addDoc(collection(db, 'clients'), clientData)
                    .then(() => {
                        resetClientForm();
                    })
                    .catch(error => {
                        console.error('Error adding client: ', error);
                    });
            }
        }

        function validateClientForm() {
            let isValid = true;
            
            // Email validation
            const email = document.getElementById('client-email').value;
            const emailError = document.getElementById('client-email-error');
            if (email && !isValidEmail(email)) {
                emailError.classList.remove('hidden');
                isValid = false;
            } else {
                emailError.classList.add('hidden');
            }
            
            // Phone validation
            const phone = document.getElementById('client-phone').value;
            const phoneError = document.getElementById('client-phone-error');
            if (!isValidPhone(phone)) {
                phoneError.classList.remove('hidden');
                isValid = false;
            } else {
                phoneError.classList.add('hidden');
            }
            
            // ID validation (if provided)
            const idNumber = document.getElementById('client-id-number').value;
            const idError = document.getElementById('client-id-error');
            if (idNumber && !isValidID(idNumber)) {
                idError.classList.remove('hidden');
                isValid = false;
            } else {
                idError.classList.add('hidden');
            }
            
            return isValid;
        }

        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function isValidPhone(phone) {
            // Basic phone validation - at least 10 digits
            const re = /^[0-9]{10,}$/;
            return re.test(phone.replace(/\D/g, ''));
        }

        function isValidID(idNumber) {
            // Basic ID validation - South African ID numbers are 13 digits
            const re = /^[0-9]{13}$/;
            return re.test(idNumber.replace(/\D/g, ''));
        }

        function resetClientForm() {
            document.getElementById('client-form').reset();
            document.getElementById('client-id').value = '';
            document.getElementById('client-form-title').textContent = 'Add New Client';
            editingClientId = null;
            
            // Clear validation errors
            document.getElementById('client-email-error').classList.add('hidden');
            document.getElementById('client-phone-error').classList.add('hidden');
            document.getElementById('client-id-error').classList.add('hidden');
        }

        function editClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (client) {
                document.getElementById('client-id').value = client.id;
                document.getElementById('client-name').value = client.name || '';
                document.getElementById('client-surname').value = client.surname || '';
                document.getElementById('client-email').value = client.email || '';
                document.getElementById('client-phone').value = client.phone || '';
                document.getElementById('client-mom-phone').value = client.momPhone || '';
                document.getElementById('client-dad-phone').value = client.dadPhone || '';
                document.getElementById('client-id-number').value = client.idNumber || '';
                document.getElementById('client-status').value = client.status || 'Active';
                document.getElementById('client-learners-code').value = client.learnersCode || '1';
                document.getElementById('client-license-code').value = client.licenseCode || 'B';
                document.getElementById('client-course-fee').value = client.courseFee || '';
                
                document.getElementById('client-form-title').textContent = 'Edit Client';
                editingClientId = clientId;
                
                // Scroll to form
                document.getElementById('client-form').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteClient(clientId) {
            showConfirmationModal(
                'Delete Client',
                'Are you sure you want to delete this client? This action cannot be undone.',
                () => {
                    deleteDoc(doc(db, 'clients', clientId))
                        .then(() => {
                            console.log('Client deleted successfully');
                        })
                        .catch(error => {
                            console.error('Error deleting client: ', error);
                        });
                }
            );
        }

        function searchClients() {
            filterAndSortClients();
        }

        function clearSearch() {
            document.getElementById('client-search').value = '';
            filterAndSortClients();
        }

        function filterAndSortClients() {
            const searchTerm = document.getElementById('client-search').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const sortBy = document.getElementById('sort-by').value;
            const sortOrder = document.getElementById('sort-order').value;
            
            let filteredClients = clients;
            
            // Apply search filter
            if (searchTerm) {
                filteredClients = filteredClients.filter(client => 
                    (client.name && client.name.toLowerCase().includes(searchTerm)) ||
                    (client.surname && client.surname.toLowerCase().includes(searchTerm)) ||
                    (client.email && client.email.toLowerCase().includes(searchTerm)) ||
                    (client.phone && client.phone.includes(searchTerm)) ||
                    (client.idNumber && client.idNumber.includes(searchTerm))
                );
            }
            
            // Apply status filter
            if (statusFilter !== 'all') {
                filteredClients = filteredClients.filter(client => client.status === statusFilter);
            }
            
            // Apply sorting
            filteredClients.sort((a, b) => {
                let aValue, bValue;
                
                switch (sortBy) {
                    case 'name':
                        aValue = `${a.name} ${a.surname}`.toLowerCase();
                        bValue = `${b.name} ${b.surname}`.toLowerCase();
                        break;
                    case 'registrationDate':
                        aValue = a.registrationDate?.seconds || 0;
                        bValue = b.registrationDate?.seconds || 0;
                        break;
                    case 'status':
                        aValue = a.status || '';
                        bValue = b.status || '';
                        break;
                    default:
                        aValue = a.name || '';
                        bValue = b.name || '';
                }
                
                if (sortOrder === 'desc') {
                    return aValue < bValue ? 1 : aValue > bValue ? -1 : 0;
                } else {
                    return aValue > bValue ? 1 : aValue < bValue ? -1 : 0;
                }
            });
            
            updateClientList(filteredClients);
        }

        function updateClientList(clientsToShow = clients) {
            const clientList = document.getElementById('client-list');
            
            if (clientsToShow.length === 0) {
                clientList.innerHTML = '<p class="text-center py-4">No clients found</p>';
                return;
            }

            let html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Registration</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            clientsToShow.forEach(client => {
                const registrationDate = client.registrationDate ? 
                    new Date(client.registrationDate.seconds * 1000).toLocaleDateString() : 'N/A';
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${client.name} ${client.surname}</div>
                                    <div class="text-sm text-gray-500">ID: ${client.idNumber || 'N/A'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${client.phone || 'N/A'}</div>
                            <div class="text-sm text-gray-500">${client.email || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                ${client.status === 'Active' ? 'bg-green-100 text-green-800' : 
                                  client.status === 'Completed' ? 'bg-blue-100 text-blue-800' : 
                                  'bg-red-100 text-red-800'}">
                                ${client.status || 'Unknown'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${registrationDate}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-red-600 hover:text-red-900 mr-3 view-client" data-id="${client.id}">View</button>
                            <button class="text-indigo-600 hover:text-indigo-900 mr-3 edit-client" data-id="${client.id}">Edit</button>
                            <button class="text-red-600 hover:text-red-900 delete-client" data-id="${client.id}">Delete</button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;

            clientList.innerHTML = html;

            // Add event listeners to the buttons
            document.querySelectorAll('.view-client').forEach(button => {
                button.addEventListener('click', function() {
                    showClientDetail(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.edit-client').forEach(button => {
                button.addEventListener('click', function() {
                    editClient(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.delete-client').forEach(button => {
                button.addEventListener('click', function() {
                    deleteClient(this.getAttribute('data-id'));
                });
            });
        }

        function showClientDetail(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            const clientPayments = payments.filter(p => p.clientId === clientId);
            const clientLessons = lessons.filter(l => l.clientId === clientId);
            const totalPaid = clientPayments.reduce((sum, payment) => sum + parseFloat(payment.amount || 0), 0);
            const courseFee = client.courseFee || 0;
            const balanceDue = courseFee - totalPaid;

            let html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h4 class="text-lg font-semibold mb-2 text-gray-800">Personal Information</h4>
                        <div class="bg-gray-50 p-4 rounded">
                            <p><strong>Name:</strong> ${client.name} ${client.surname}</p>
                            <p><strong>Email:</strong> ${client.email || 'N/A'}</p>
                            <p><strong>Phone:</strong> ${client.phone || 'N/A'}</p>
                            <p><strong>ID Number:</strong> ${client.idNumber || 'N/A'}</p>
                            <p><strong>Mom's Number:</strong> ${client.momPhone || 'N/A'}</p>
                            <p><strong>Dad's Number:</strong> ${client.dadPhone || 'N/A'}</p>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold mb-2 text-gray-800">Course Information</h4>
                        <div class="bg-gray-50 p-4 rounded">
                            <p><strong>Status:</strong> ${client.status || 'N/A'}</p>
                            <p><strong>Learner's Code:</strong> ${client.learnersCode || 'N/A'}</p>
                            <p><strong>License Code:</strong> ${client.licenseCode || 'N/A'}</p>
                            <p><strong>Registration Date:</strong> ${client.registrationDate ? 
                                new Date(client.registrationDate.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
                        </div>
                    </div>
                </div>
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-2 text-gray-800">Financial Summary</h4>
                    <div class="bg-gray-50 p-4 rounded grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <p><strong>Total Course Fee:</strong> R ${courseFee.toFixed(2)}</p>
                        </div>
                        <div>
                            <p><strong>Total Amount Paid:</strong> R ${totalPaid.toFixed(2)}</p>
                        </div>
                        <div>
                            <p><strong>Remaining Balance:</strong> R ${balanceDue.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-2 text-gray-800">Payment History</h4>
            `;

            if (clientPayments.length > 0) {
                html += `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;

                clientPayments.forEach(payment => {
                    const paymentDate = payment.date ? 
                        new Date(payment.date.seconds * 1000).toLocaleDateString() : 'N/A';
                    
                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${paymentDate}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R ${parseFloat(payment.amount).toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${payment.method}</td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div>`;
            } else {
                html += '<p class="text-center py-4">No payment history found</p>';
            }

            html += `
                </div>
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-2 text-gray-800">Lesson History</h4>
            `;

            if (clientLessons.length > 0) {
                html += `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Instructor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;

                clientLessons.forEach(lesson => {
                    const lessonDate = lesson.date ? 
                        new Date(lesson.date.seconds * 1000).toLocaleDateString() : 'N/A';
                    const instructor = instructors.find(i => i.id === lesson.instructorId);
                    const instructorName = instructor ? `${instructor.name} ${instructor.surname}` : 'Unknown';
                    
                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lessonDate}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lesson.time || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${instructorName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lesson.type}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">${lesson.notes || 'N/A'}</td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div>`;
            } else {
                html += '<p class="text-center py-4">No lesson history found</p>';
            }

            html += `
                </div>
                <div class="mt-6 flex justify-end">
                    <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded edit-client-detail" data-id="${client.id}">
                        Edit Client
                    </button>
                </div>
            `;

            document.getElementById('client-detail-content').innerHTML = html;
            document.getElementById('client-detail-modal').classList.remove('hidden');

            // Add event listener to the edit button in the modal
            document.querySelector('.edit-client-detail').addEventListener('click', function() {
                closeClientModal();
                editClient(this.getAttribute('data-id'));
            });

            // Prepare print view
            prepareClientPrintView(client, clientPayments, clientLessons, totalPaid, courseFee, balanceDue);
        }

        function prepareClientPrintView(client, payments, lessons, totalPaid, courseFee, balanceDue) {
            const printView = document.getElementById('client-print-view');
            
            let html = `
                <div class="p-8">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-gray-800">BonusDrivingSchool</h1>
                        <h2 class="text-xl text-gray-600">Client Profile</h2>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Personal Information</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p><strong>Name:</strong> ${client.name} ${client.surname}</p>
                                <p><strong>Email:</strong> ${client.email || 'N/A'}</p>
                                <p><strong>Phone:</strong> ${client.phone || 'N/A'}</p>
                            </div>
                            <div>
                                <p><strong>ID Number:</strong> ${client.idNumber || 'N/A'}</p>
                                <p><strong>Mom's Number:</strong> ${client.momPhone || 'N/A'}</p>
                                <p><strong>Dad's Number:</strong> ${client.dadPhone || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Course Information</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p><strong>Status:</strong> ${client.status || 'N/A'}</p>
                                <p><strong>Learner's Code:</strong> ${client.learnersCode || 'N/A'}</p>
                            </div>
                            <div>
                                <p><strong>License Code:</strong> ${client.licenseCode || 'N/A'}</p>
                                <p><strong>Registration Date:</strong> ${client.registrationDate ? 
                                    new Date(client.registrationDate.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Financial Summary</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <p><strong>Total Course Fee:</strong> R ${courseFee.toFixed(2)}</p>
                            </div>
                            <div>
                                <p><strong>Total Amount Paid:</strong> R ${totalPaid.toFixed(2)}</p>
                            </div>
                            <div>
                                <p><strong>Remaining Balance:</strong> R ${balanceDue.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
            `;

            if (payments.length > 0) {
                html += `
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Payment History</h3>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;

                payments.forEach(payment => {
                    const paymentDate = payment.date ? 
                        new Date(payment.date.seconds * 1000).toLocaleDateString() : 'N/A';
                    
                    html += `
                        <tr>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${paymentDate}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">R ${parseFloat(payment.amount).toFixed(2)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${payment.method}</td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div>`;
            }

            if (lessons.length > 0) {
                html += `
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Lesson History</h3>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Instructor</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;

                lessons.forEach(lesson => {
                    const lessonDate = lesson.date ? 
                        new Date(lesson.date.seconds * 1000).toLocaleDateString() : 'N/A';
                    const instructor = instructors.find(i => i.id === lesson.instructorId);
                    const instructorName = instructor ? `${instructor.name} ${instructor.surname}` : 'Unknown';
                    
                    html += `
                        <tr>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${lessonDate}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${lesson.time || 'N/A'}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${instructorName}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${lesson.type}</td>
                            <td class="px-4 py-2 text-sm text-gray-500">${lesson.notes || 'N/A'}</td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div>`;
            }

            html += `</div>`;

            printView.innerHTML = html;
        }

        function printClientProfile() {
            window.print();
        }

        function closeClientModal() {
            document.getElementById('client-detail-modal').classList.add('hidden');
        }

        // Payment management functions
        function handlePaymentSubmit(e) {
            e.preventDefault();
            
            const paymentData = {
                clientId: document.getElementById('payment-client').value,
                date: new Date(document.getElementById('payment-date').value),
                amount: parseFloat(document.getElementById('payment-amount').value),
                method: document.getElementById('payment-method').value
            };

            if (editingPaymentId) {
                // Update existing payment
                updateDoc(doc(db, 'payments', editingPaymentId), paymentData)
                    .then(() => {
                        resetPaymentForm();
                    })
                    .catch(error => {
                        console.error('Error updating payment: ', error);
                    });
            } else {
                // Add new payment
                addDoc(collection(db, 'payments'), paymentData)
                    .then(() => {
                        resetPaymentForm();
                    })
                    .catch(error => {
                        console.error('Error adding payment: ', error);
                    });
            }
        }

        function resetPaymentForm() {
            document.getElementById('payment-form').reset();
            document.getElementById('payment-id').value = '';
            document.getElementById('payment-date').valueAsDate = new Date();
            document.getElementById('payment-form-title').textContent = 'Add New Payment';
            editingPaymentId = null;
        }

        function updatePaymentList() {
            const paymentList = document.getElementById('payment-list');
            
            if (payments.length === 0) {
                paymentList.innerHTML = '<p class="text-center py-4">No payments found</p>';
                return;
            }

            let html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            payments.forEach(payment => {
                const client = clients.find(c => c.id === payment.clientId);
                const clientName = client ? `${client.name} ${client.surname}` : 'Unknown Client';
                const paymentDate = payment.date ? 
                    new Date(payment.date.seconds * 1000).toLocaleDateString() : 'N/A';
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${clientName}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${paymentDate}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            R ${parseFloat(payment.amount).toFixed(2)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${payment.method}
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;

            paymentList.innerHTML = html;
        }

        function updateFinancialSummary() {
            const financialSummary = document.getElementById('financial-summary');
            
            if (clients.length === 0) {
                financialSummary.innerHTML = '<p class="text-center py-4">No clients found</p>';
                return;
            }

            let html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Course Fee</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Paid</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance Due</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            clients.forEach(client => {
                const clientPayments = payments.filter(p => p.clientId === client.id);
                const totalPaid = clientPayments.reduce((sum, payment) => sum + parseFloat(payment.amount || 0), 0);
                const courseFee = client.courseFee || 0;
                const balanceDue = courseFee - totalPaid;
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${client.name} ${client.surname}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            R ${courseFee.toFixed(2)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            R ${totalPaid.toFixed(2)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium 
                            ${balanceDue > 0 ? 'text-red-600' : 'text-green-600'}">
                            R ${balanceDue.toFixed(2)}
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;

            financialSummary.innerHTML = html;
        }

        // Instructor management functions
        function handleInstructorSubmit(e) {
            e.preventDefault();
            
            const instructorData = {
                name: document.getElementById('instructor-name').value,
                surname: document.getElementById('instructor-surname').value,
                email: document.getElementById('instructor-email').value,
                phone: document.getElementById('instructor-phone').value,
                calendarId: document.getElementById('instructor-calendar-id').value
            };

            if (editingInstructorId) {
                // Update existing instructor
                updateDoc(doc(db, 'instructors', editingInstructorId), instructorData)
                    .then(() => {
                        resetInstructorForm();
                    })
                    .catch(error => {
                        console.error('Error updating instructor: ', error);
                    });
            } else {
                // Add new instructor
                addDoc(collection(db, 'instructors'), instructorData)
                    .then(() => {
                        resetInstructorForm();
                    })
                    .catch(error => {
                        console.error('Error adding instructor: ', error);
                    });
            }
        }

        function resetInstructorForm() {
            document.getElementById('instructor-form').reset();
            document.getElementById('instructor-id').value = '';
            document.getElementById('instructor-form-title').textContent = 'Add New Instructor';
            editingInstructorId = null;
        }

        function editInstructor(instructorId) {
            const instructor = instructors.find(i => i.id === instructorId);
            if (instructor) {
                document.getElementById('instructor-id').value = instructor.id;
                document.getElementById('instructor-name').value = instructor.name || '';
                document.getElementById('instructor-surname').value = instructor.surname || '';
                document.getElementById('instructor-email').value = instructor.email || '';
                document.getElementById('instructor-phone').value = instructor.phone || '';
                document.getElementById('instructor-calendar-id').value = instructor.calendarId || '';
                
                document.getElementById('instructor-form-title').textContent = 'Edit Instructor';
                editingInstructorId = instructorId;
                
                // Scroll to form
                document.getElementById('instructor-form').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteInstructor(instructorId) {
            showConfirmationModal(
                'Delete Instructor',
                'Are you sure you want to delete this instructor? This action cannot be undone.',
                () => {
                    deleteDoc(doc(db, 'instructors', instructorId))
                        .then(() => {
                            console.log('Instructor deleted successfully');
                        })
                        .catch(error => {
                            console.error('Error deleting instructor: ', error);
                        });
                }
            );
        }

        function updateInstructorList() {
            const instructorList = document.getElementById('instructor-list');
            
            if (instructors.length === 0) {
                instructorList.innerHTML = '<p class="text-center py-4">No instructors found</p>';
                return;
            }

            let html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Calendar ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            instructors.forEach(instructor => {
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${instructor.name} ${instructor.surname}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${instructor.phone || 'N/A'}</div>
                            <div class="text-sm text-gray-500">${instructor.email || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${instructor.calendarId || 'Not set'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-indigo-600 hover:text-indigo-900 mr-3 edit-instructor" data-id="${instructor.id}">Edit</button>
                            <button class="text-red-600 hover:text-red-900 delete-instructor" data-id="${instructor.id}">Delete</button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;

            instructorList.innerHTML = html;

            // Add event listeners to the buttons
            document.querySelectorAll('.edit-instructor').forEach(button => {
                button.addEventListener('click', function() {
                    editInstructor(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.delete-instructor').forEach(button => {
                button.addEventListener('click', function() {
                    deleteInstructor(this.getAttribute('data-id'));
                });
            });
        }

        // Vehicle management functions
        function handleVehicleSubmit(e) {
            e.preventDefault();
            
            const vehicleData = {
                make: document.getElementById('vehicle-make').value,
                model: document.getElementById('vehicle-model').value,
                year: document.getElementById('vehicle-year').value ? parseInt(document.getElementById('vehicle-year').value) : null,
                licensePlate: document.getElementById('vehicle-license').value,
                status: document.getElementById('vehicle-status').value
            };

            if (editingVehicleId) {
                // Update existing vehicle
                updateDoc(doc(db, 'vehicles', editingVehicleId), vehicleData)
                    .then(() => {
                        resetVehicleForm();
                    })
                    .catch(error => {
                        console.error('Error updating vehicle: ', error);
                    });
            } else {
                // Add new vehicle
                addDoc(collection(db, 'vehicles'), vehicleData)
                    .then(() => {
                        resetVehicleForm();
                    })
                    .catch(error => {
                        console.error('Error adding vehicle: ', error);
                    });
            }
        }

        function resetVehicleForm() {
            document.getElementById('vehicle-form').reset();
            document.getElementById('vehicle-id').value = '';
            document.getElementById('vehicle-form-title').textContent = 'Add New Vehicle';
            editingVehicleId = null;
        }

        function editVehicle(vehicleId) {
            const vehicle = vehicles.find(v => v.id === vehicleId);
            if (vehicle) {
                document.getElementById('vehicle-id').value = vehicle.id;
                document.getElementById('vehicle-make').value = vehicle.make || '';
                document.getElementById('vehicle-model').value = vehicle.model || '';
                document.getElementById('vehicle-year').value = vehicle.year || '';
                document.getElementById('vehicle-license').value = vehicle.licensePlate || '';
                document.getElementById('vehicle-status').value = vehicle.status || 'Available';
                
                document.getElementById('vehicle-form-title').textContent = 'Edit Vehicle';
                editingVehicleId = vehicleId;
                
                // Scroll to form
                document.getElementById('vehicle-form').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteVehicle(vehicleId) {
            showConfirmationModal(
                'Delete Vehicle',
                'Are you sure you want to delete this vehicle? This action cannot be undone.',
                () => {
                    deleteDoc(doc(db, 'vehicles', vehicleId))
                        .then(() => {
                            console.log('Vehicle deleted successfully');
                        })
                        .catch(error => {
                            console.error('Error deleting vehicle: ', error);
                        });
                }
            );
        }

        function updateVehicleList() {
            const vehicleList = document.getElementById('vehicle-list');
            
            if (vehicles.length === 0) {
                vehicleList.innerHTML = '<p class="text-center py-4">No vehicles found</p>';
                return;
            }

            let html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Make & Model</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">License Plate</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            vehicles.forEach(vehicle => {
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${vehicle.make} ${vehicle.model}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${vehicle.year || 'N/A'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${vehicle.licensePlate}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                ${vehicle.status === 'Available' ? 'bg-green-100 text-green-800' : 
                                  vehicle.status === 'In Use' ? 'bg-yellow-100 text-yellow-800' : 
                                  vehicle.status === 'Maintenance' ? 'bg-blue-100 text-blue-800' : 
                                  'bg-red-100 text-red-800'}">
                                ${vehicle.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-indigo-600 hover:text-indigo-900 mr-3 edit-vehicle" data-id="${vehicle.id}">Edit</button>
                            <button class="text-red-600 hover:text-red-900 delete-vehicle" data-id="${vehicle.id}">Delete</button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;

            vehicleList.innerHTML = html;

            // Add event listeners to the buttons
            document.querySelectorAll('.edit-vehicle').forEach(button => {
                button.addEventListener('click', function() {
                    editVehicle(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.delete-vehicle').forEach(button => {
                button.addEventListener('click', function() {
                    deleteVehicle(this.getAttribute('data-id'));
                });
            });
        }

        // Scheduling functions
        function handleLessonSubmit(e) {
            e.preventDefault();
            
            const lessonData = {
                clientId: document.getElementById('lesson-client').value,
                instructorId: document.getElementById('lesson-instructor').value,
                vehicleId: document.getElementById('lesson-vehicle').value || null,
                type: document.getElementById('lesson-type').value,
                date: new Date(document.getElementById('lesson-date').value),
                time: document.getElementById('lesson-time').value,
                duration: parseInt(document.getElementById('lesson-duration').value),
                notes: document.getElementById('lesson-notes').value
            };

            if (editingLessonId) {
                // Update existing lesson
                updateDoc(doc(db, 'lessons', editingLessonId), lessonData)
                    .then(() => {
                        resetLessonForm();
                        // Sync with Google Calendar
                        syncLessonToCalendar(editingLessonId, lessonData);
                    })
                    .catch(error => {
                        console.error('Error updating lesson: ', error);
                    });
            } else {
                // Add new lesson
                addDoc(collection(db, 'lessons'), lessonData)
                    .then((docRef) => {
                        resetLessonForm();
                        // Sync with Google Calendar
                        syncLessonToCalendar(docRef.id, lessonData);
                    })
                    .catch(error => {
                        console.error('Error adding lesson: ', error);
                    });
            }
        }

        function resetLessonForm() {
            document.getElementById('lesson-form').reset();
            document.getElementById('lesson-id').value = '';
            document.getElementById('lesson-date').valueAsDate = new Date();
            document.getElementById('lesson-duration').value = '60';
            document.getElementById('lesson-form-title').textContent = 'Schedule New Lesson';
            editingLessonId = null;
        }

        function syncLessonToCalendar(lessonId, lessonData) {
            // This is a stub for Google Calendar integration
            // In a real implementation, you would use the Google Calendar API
            console.log('Syncing lesson to Google Calendar:', lessonId, lessonData);
            
            const instructor = instructors.find(i => i.id === lessonData.instructorId);
            if (instructor && instructor.calendarId) {
                // Here you would make an API call to Google Calendar
                // For now, we'll just log the intended action
                console.log(`Would sync to calendar: ${instructor.calendarId}`);
            }
        }

        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: lessons.map(lesson => {
                    const client = clients.find(c => c.id === lesson.clientId);
                    const instructor = instructors.find(i => i.id === lesson.instructorId);
                    const clientName = client ? `${client.name} ${client.surname}` : 'Unknown Client';
                    const instructorName = instructor ? `${instructor.name} ${instructor.surname}` : 'Unknown Instructor';
                    
                    const start = new Date(lesson.date.seconds * 1000);
                    const [hours, minutes] = lesson.time.split(':');
                    start.setHours(parseInt(hours), parseInt(minutes));
                    
                    const end = new Date(start);
                    end.setMinutes(end.getMinutes() + lesson.duration);
                    
                    return {
                        id: lesson.id,
                        title: `${clientName} - ${lesson.type}`,
                        start: start,
                        end: end,
                        extendedProps: {
                            client: clientName,
                            instructor: instructorName,
                            type: lesson.type,
                            notes: lesson.notes
                        }
                    };
                }),
                eventClick: function(info) {
                    showLessonDetail(info.event.id);
                }
            });
            
            calendar.render();
        }

        function updateCalendar() {
            // This would refresh the calendar when lessons change
            // For simplicity, we'll just reinitialize it
            if (document.getElementById('calendar').children.length > 0) {
                initializeCalendar();
            }
        }

        function showLessonDetail(lessonId) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (!lesson) return;
            
            const client = clients.find(c => c.id === lesson.clientId);
            const instructor = instructors.find(i => i.id === lesson.instructorId);
            const vehicle = vehicles.find(v => v.id === lesson.vehicleId);
            
            const clientName = client ? `${client.name} ${client.surname}` : 'Unknown Client';
            const instructorName = instructor ? `${instructor.name} ${instructor.surname}` : 'Unknown Instructor';
            const vehicleInfo = vehicle ? `${vehicle.make} ${vehicle.model} (${vehicle.licensePlate})` : 'Not assigned';
            
            const lessonDate = lesson.date ? 
                new Date(lesson.date.seconds * 1000).toLocaleDateString() : 'N/A';
            
            let html = `
                <div class="space-y-4">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800">Lesson Information</h4>
                        <div class="bg-gray-50 p-4 rounded mt-2">
                            <p><strong>Client:</strong> ${clientName}</p>
                            <p><strong>Instructor:</strong> ${instructorName}</p>
                            <p><strong>Vehicle:</strong> ${vehicleInfo}</p>
                            <p><strong>Type:</strong> ${lesson.type}</p>
                            <p><strong>Date:</strong> ${lessonDate}</p>
                            <p><strong>Time:</strong> ${lesson.time}</p>
                            <p><strong>Duration:</strong> ${lesson.duration} minutes</p>
                            <p><strong>Notes:</strong> ${lesson.notes || 'No notes'}</p>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded edit-lesson" data-id="${lesson.id}">
                        Edit Lesson
                    </button>
                </div>
            `;

            document.getElementById('lesson-detail-content').innerHTML = html;
            document.getElementById('lesson-detail-modal').classList.remove('hidden');

            // Add event listener to the edit button
            document.querySelector('.edit-lesson').addEventListener('click', function() {
                closeLessonModal();
                editLesson(this.getAttribute('data-id'));
            });
        }

        function editLesson(lessonId) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (lesson) {
                document.getElementById('lesson-id').value = lesson.id;
                document.getElementById('lesson-client').value = lesson.clientId;
                document.getElementById('lesson-instructor').value = lesson.instructorId;
                document.getElementById('lesson-vehicle').value = lesson.vehicleId || '';
                document.getElementById('lesson-type').value = lesson.type;
                document.getElementById('lesson-date').valueAsDate = new Date(lesson.date.seconds * 1000);
                document.getElementById('lesson-time').value = lesson.time;
                document.getElementById('lesson-duration').value = lesson.duration;
                document.getElementById('lesson-notes').value = lesson.notes || '';
                
                document.getElementById('lesson-form-title').textContent = 'Edit Lesson';
                editingLessonId = lessonId;
                
                // Switch to scheduling tab and scroll to form
                showTab('scheduling');
                document.getElementById('lesson-form').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function closeLessonModal() {
            document.getElementById('lesson-detail-modal').classList.add('hidden');
        }

        // Instructor schedule functions
        function initializeInstructorCalendar() {
            if (currentUserRole !== 'instructor') return;
            
            // Find the instructor by email
            const instructor = instructors.find(i => i.email === currentUser.email);
            if (!instructor) return;
            
            const instructorLessons = lessons.filter(l => l.instructorId === instructor.id);
            
            const calendarEl = document.getElementById('instructor-calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: instructorLessons.map(lesson => {
                    const client = clients.find(c => c.id === lesson.clientId);
                    const clientName = client ? `${client.name} ${client.surname}` : 'Unknown Client';
                    
                    const start = new Date(lesson.date.seconds * 1000);
                    const [hours, minutes] = lesson.time.split(':');
                    start.setHours(parseInt(hours), parseInt(minutes));
                    
                    const end = new Date(start);
                    end.setMinutes(end.getMinutes() + lesson.duration);
                    
                    return {
                        id: lesson.id,
                        title: `${clientName} - ${lesson.type}`,
                        start: start,
                        end: end,
                        extendedProps: {
                            client: clientName,
                            type: lesson.type,
                            notes: lesson.notes
                        }
                    };
                }),
                eventClick: function(info) {
                    showInstructorLessonDetail(info.event.id);
                }
            });
            
            calendar.render();
        }

        function loadInstructorLessons() {
            if (currentUserRole !== 'instructor') return;
            
            // Find the instructor by email
            const instructor = instructors.find(i => i.email === currentUser.email);
            if (!instructor) return;
            
            const instructorLessons = lessons.filter(l => l.instructorId === instructor.id);
            const instructorLessonsContainer = document.getElementById('instructor-lessons');
            
            if (instructorLessons.length === 0) {
                instructorLessonsContainer.innerHTML = '<p class="text-center py-4">No lessons scheduled</p>';
                return;
            }

            let html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            instructorLessons.forEach(lesson => {
                const client = clients.find(c => c.id === lesson.clientId);
                const clientName = client ? `${client.name} ${client.surname}` : 'Unknown Client';
                const clientPhone = client ? client.phone : 'N/A';
                const lessonDate = lesson.date ? 
                    new Date(lesson.date.seconds * 1000).toLocaleDateString() : 'N/A';
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${lessonDate}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${lesson.time}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${clientName}</div>
                            <div class="text-sm text-gray-500">${clientPhone}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${lesson.type}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                            ${lesson.notes || 'No notes'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-indigo-600 hover:text-indigo-900 update-lesson-progress" data-id="${lesson.id}">
                                Update Progress
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;

            instructorLessonsContainer.innerHTML = html;

            // Add event listeners to update progress buttons
            document.querySelectorAll('.update-lesson-progress').forEach(button => {
                button.addEventListener('click', function() {
                    updateLessonProgress(this.getAttribute('data-id'));
                });
            });
        }

        function showInstructorLessonDetail(lessonId) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (!lesson) return;
            
            const client = clients.find(c => c.id === lesson.clientId);
            const clientName = client ? `${client.name} ${client.surname}` : 'Unknown Client';
            const clientPhone = client ? client.phone : 'N/A';
            const clientEmail = client ? client.email : 'N/A';
            
            const lessonDate = lesson.date ? 
                new Date(lesson.date.seconds * 1000).toLocaleDateString() : 'N/A';
            
            let html = `
                <div class="space-y-4">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800">Lesson Information</h4>
                        <div class="bg-gray-50 p-4 rounded mt-2">
                            <p><strong>Client:</strong> ${clientName}</p>
                            <p><strong>Phone:</strong> ${clientPhone}</p>
                            <p><strong>Email:</strong> ${clientEmail}</p>
                            <p><strong>Type:</strong> ${lesson.type}</p>
                            <p><strong>Date:</strong> ${lessonDate}</p>
                            <p><strong>Time:</strong> ${lesson.time}</p>
                            <p><strong>Duration:</strong> ${lesson.duration} minutes</p>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800">Current Notes</h4>
                        <div class="bg-gray-50 p-4 rounded mt-2">
                            <p>${lesson.notes || 'No notes yet'}</p>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800">Update Progress</h4>
                        <form id="update-progress-form">
                            <input type="hidden" id="progress-lesson-id" value="${lesson.id}">
                            <div class="mt-2">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="progress-notes">
                                    Add Notes
                                </label>
                                <textarea id="progress-notes" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Add notes about the lesson progress..."></textarea>
                            </div>
                            <div class="mt-4 flex justify-end">
                                <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                                    Update Progress
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById('lesson-detail-content').innerHTML = html;
            document.getElementById('lesson-detail-modal').classList.remove('hidden');

            // Add event listener to the update progress form
            document.getElementById('update-progress-form').addEventListener('submit', function(e) {
                e.preventDefault();
                updateLessonProgressNotes(lesson.id);
            });
        }

        function updateLessonProgress(lessonId) {
            showInstructorLessonDetail(lessonId);
        }

        function updateLessonProgressNotes(lessonId) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (!lesson) return;
            
            const progressNotes = document.getElementById('progress-notes').value;
            const updatedNotes = lesson.notes ? `${lesson.notes}\n${new Date().toLocaleDateString()}: ${progressNotes}` : `${new Date().toLocaleDateString()}: ${progressNotes}`;
            
            updateDoc(doc(db, 'lessons', lessonId), {
                notes: updatedNotes
            })
            .then(() => {
                closeLessonModal();
                loadInstructorLessons();
            })
            .catch(error => {
                console.error('Error updating lesson progress: ', error);
            });
        }

        // Dashboard functions
        function updateDashboard() {
            // Update client counts
            document.getElementById('total-clients').textContent = clients.length;
            const activeClients = clients.filter(client => client.status === 'Active').length;
            document.getElementById('active-clients').textContent = activeClients;

            // Update financial data
            const totalRevenue = payments.reduce((sum, payment) => sum + parseFloat(payment.amount || 0), 0);
            document.getElementById('total-revenue').textContent = `R ${totalRevenue.toFixed(2)}`;
            
            // Calculate pending payments
            let pendingPayments = 0;
            clients.forEach(client => {
                const clientPayments = payments.filter(p => p.clientId === client.id);
                const totalPaid = clientPayments.reduce((sum, payment) => sum + parseFloat(payment.amount || 0), 0);
                const courseFee = client.courseFee || 0;
                const balanceDue = courseFee - totalPaid;
                if (balanceDue > 0) {
                    pendingPayments += balanceDue;
                }
            });
            
            document.getElementById('pending-payments').textContent = `R ${pendingPayments.toFixed(2)}`;

            // Update recent clients
            updateRecentClients();
            
            // Update recent payments
            updateRecentPayments();
        }

        function updateRecentClients() {
            const recentClients = document.getElementById('recent-clients');
            const recent = clients.slice(0, 5); // Get 5 most recent clients
            
            if (recent.length === 0) {
                recentClients.innerHTML = '<p class="text-center py-4">No clients found</p>';
                return;
            }

            let html = '';
            recent.forEach(client => {
                const registrationDate = client.registrationDate ? 
                    new Date(client.registrationDate.seconds * 1000).toLocaleDateString() : 'N/A';
                
                html += `
                    <div class="border-b border-gray-200 py-3">
                        <div class="flex justify-between">
                            <div>
                                <p class="font-medium">${client.name} ${client.surname}</p>
                                <p class="text-sm text-gray-500">${client.phone || 'No phone'}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-500">${registrationDate}</p>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                    ${client.status === 'Active' ? 'bg-green-100 text-green-800' : 
                                      client.status === 'Completed' ? 'bg-blue-100 text-blue-800' : 
                                      'bg-red-100 text-red-800'}">
                                    ${client.status || 'Unknown'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });

            recentClients.innerHTML = html;
        }

        function updateRecentPayments() {
            const recentPayments = document.getElementById('recent-payments');
            const recent = payments.slice(0, 5); // Get 5 most recent payments
            
            if (recent.length === 0) {
                recentPayments.innerHTML = '<p class="text-center py-4">No payments found</p>';
                return;
            }

            let html = '';
            recent.forEach(payment => {
                const client = clients.find(c => c.id === payment.clientId);
                const clientName = client ? `${client.name} ${client.surname}` : 'Unknown Client';
                const paymentDate = payment.date ? 
                    new Date(payment.date.seconds * 1000).toLocaleDateString() : 'N/A';
                
                html += `
                    <div class="border-b border-gray-200 py-3">
                        <div class="flex justify-between">
                            <div>
                                <p class="font-medium">${clientName}</p>
                                <p class="text-sm text-gray-500">${payment.method}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-medium">R ${parseFloat(payment.amount).toFixed(2)}</p>
                                <p class="text-sm text-gray-500">${paymentDate}</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            recentPayments.innerHTML = html;
        }

        // Import functions
        function handleImport() {
            const importType = document.getElementById('import-type').value;
            const fileInput = document.getElementById('excel-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an Excel file to import.');
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Get the first worksheet
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                if (importType === 'clients') {
                    importClients(jsonData);
                } else if (importType === 'payments') {
                    importPayments(jsonData);
                } else if (importType === 'instructors') {
                    importInstructors(jsonData);
                } else if (importType === 'vehicles') {
                    importVehicles(jsonData);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function importClients(data) {
            let results = {
                success: 0,
                errors: 0,
                details: []
            };

            // Process each row
            data.forEach((row, index) => {
                try {
                    // Map Excel columns to client fields
                    const clientData = {
                        name: row['Name'] || row['name'] || '',
                        surname: row['Surname'] || row['surname'] || '',
                        email: row['Email'] || row['email'] || '',
                        phone: row['Phone'] || row['phone'] || '',
                        momPhone: row['Mom Phone'] || row['mom_phone'] || row['momPhone'] || '',
                        dadPhone: row['Dad Phone'] || row['dad_phone'] || row['dadPhone'] || '',
                        idNumber: row['ID Number'] || row['id_number'] || row['idNumber'] || '',
                        status: row['Status'] || row['status'] || 'Active',
                        learnersCode: row['Learners Code'] || row['learners_code'] || row['learnersCode'] || '1',
                        licenseCode: row['License Code'] || row['license_code'] || row['licenseCode'] || 'B',
                        courseFee: row['Course Fee'] || row['course_fee'] || row['courseFee'] || 0,
                        registrationDate: serverTimestamp()
                    };

                    // Validate required fields
                    if (!clientData.name || !clientData.surname || !clientData.phone) {
                        throw new Error('Missing required fields (name, surname, phone)');
                    }

                    // Add to Firestore
                    addDoc(collection(db, 'clients'), clientData)
                        .then(() => {
                            results.success++;
                            results.details.push(`Row ${index + 1}: Successfully imported ${clientData.name} ${clientData.surname}`);
                            updateImportResults(results);
                        })
                        .catch(error => {
                            results.errors++;
                            results.details.push(`Row ${index + 1}: Error - ${error.message}`);
                            updateImportResults(results);
                        });

                } catch (error) {
                    results.errors++;
                    results.details.push(`Row ${index + 1}: Error - ${error.message}`);
                }
            });

            updateImportResults(results);
        }

        function importPayments(data) {
            let results = {
                success: 0,
                errors: 0,
                details: []
            };

            // Process each row
            data.forEach((row, index) => {
                try {
                    // Map Excel columns to payment fields
                    const clientIdentifier = row['Client ID'] || row['client_id'] || row['clientId'] || 
                                            row['Client Name'] || row['client_name'] || row['clientName'] || '';
                    
                    if (!clientIdentifier) {
                        throw new Error('Missing client identifier');
                    }

                    // Find the client by ID or name
                    let client = null;
                    if (clientIdentifier.includes(' ')) {
                        // Assume it's a name
                        const [name, surname] = clientIdentifier.split(' ');
                        client = clients.find(c => 
                            c.name.toLowerCase() === name.toLowerCase() && 
                            c.surname.toLowerCase() === surname.toLowerCase()
                        );
                    } else {
                        // Assume it's an ID
                        client = clients.find(c => c.id === clientIdentifier);
                    }

                    if (!client) {
                        throw new Error(`Client not found: ${clientIdentifier}`);
                    }

                    const paymentData = {
                        clientId: client.id,
                        date: new Date(row['Date'] || row['date'] || new Date()),
                        amount: parseFloat(row['Amount'] || row['amount'] || 0),
                        method: row['Method'] || row['method'] || 'Cash'
                    };

                    // Validate required fields
                    if (!paymentData.amount || paymentData.amount <= 0) {
                        throw new Error('Invalid amount');
                    }

                    // Add to Firestore
                    addDoc(collection(db, 'payments'), paymentData)
                        .then(() => {
                            results.success++;
                            results.details.push(`Row ${index + 1}: Successfully imported payment for ${client.name} ${client.surname}`);
                            updateImportResults(results);
                        })
                        .catch(error => {
                            results.errors++;
                            results.details.push(`Row ${index + 1}: Error - ${error.message}`);
                            updateImportResults(results);
                        });

                } catch (error) {
                    results.errors++;
                    results.details.push(`Row ${index + 1}: Error - ${error.message}`);
                }
            });

            updateImportResults(results);
        }

        function importInstructors(data) {
            let results = {
                success: 0,
                errors: 0,
                details: []
            };

            // Process each row
            data.forEach((row, index) => {
                try {
                    // Map Excel columns to instructor fields
                    const instructorData = {
                        name: row['Name'] || row['name'] || '',
                        surname: row['Surname'] || row['surname'] || '',
                        email: row['Email'] || row['email'] || '',
                        phone: row['Phone'] || row['phone'] || '',
                        calendarId: row['Calendar ID'] || row['calendar_id'] || row['calendarId'] || ''
                    };

                    // Validate required fields
                    if (!instructorData.name || !instructorData.surname || !instructorData.email) {
                        throw new Error('Missing required fields (name, surname, email)');
                    }

                    // Add to Firestore
                    addDoc(collection(db, 'instructors'), instructorData)
                        .then(() => {
                            results.success++;
                            results.details.push(`Row ${index + 1}: Successfully imported ${instructorData.name} ${instructorData.surname}`);
                            updateImportResults(results);
                        })
                        .catch(error => {
                            results.errors++;
                            results.details.push(`Row ${index + 1}: Error - ${error.message}`);
                            updateImportResults(results);
                        });

                } catch (error) {
                    results.errors++;
                    results.details.push(`Row ${index + 1}: Error - ${error.message}`);
                }
            });

            updateImportResults(results);
        }

        function importVehicles(data) {
            let results = {
                success: 0,
                errors: 0,
                details: []
            };

            // Process each row
            data.forEach((row, index) => {
                try {
                    // Map Excel columns to vehicle fields
                    const vehicleData = {
                        make: row['Make'] || row['make'] || '',
                        model: row['Model'] || row['model'] || '',
                        year: row['Year'] || row['year'] || null,
                        licensePlate: row['License Plate'] || row['license_plate'] || row['licensePlate'] || '',
                        status: row['Status'] || row['status'] || 'Available'
                    };

                    // Validate required fields
                    if (!vehicleData.make || !vehicleData.model || !vehicleData.licensePlate) {
                        throw new Error('Missing required fields (make, model, license plate)');
                    }

                    // Add to Firestore
                    addDoc(collection(db, 'vehicles'), vehicleData)
                        .then(() => {
                            results.success++;
                            results.details.push(`Row ${index + 1}: Successfully imported ${vehicleData.make} ${vehicleData.model}`);
                            updateImportResults(results);
                        })
                        .catch(error => {
                            results.errors++;
                            results.details.push(`Row ${index + 1}: Error - ${error.message}`);
                            updateImportResults(results);
                        });

                } catch (error) {
                    results.errors++;
                    results.details.push(`Row ${index + 1}: Error - ${error.message}`);
                }
            });

            updateImportResults(results);
        }

        function updateImportResults(results) {
            const importResults = document.getElementById('import-results');
            
            let html = `
                <div class="mb-4">
                    <p><strong>Import Summary:</strong> ${results.success} successful, ${results.errors} errors</p>
                </div>
            `;

            if (results.details.length > 0) {
                html += '<div class="max-h-60 overflow-y-auto border border-gray-200 rounded">';
                results.details.forEach(detail => {
                    const isError = detail.includes('Error');
                    html += `
                        <div class="p-2 border-b border-gray-200 ${isError ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}">
                            ${detail}
                        </div>
                    `;
                });
                html += '</div>';
            }

            importResults.innerHTML = html;
        }

        // Confirmation modal functions
        function showConfirmationModal(title, message, callback) {
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').textContent = message;
            confirmationCallback = callback;
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').classList.add('hidden');
            confirmationCallback = null;
        }

        function executeConfirmedAction() {
            if (confirmationCallback) {
                confirmationCallback();
            }
            closeConfirmationModal();
        }
    </script>
</body>
</html>
