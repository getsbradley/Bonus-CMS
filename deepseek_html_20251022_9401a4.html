<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BonusDrivingSchool</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- SheetJS for Excel import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        /* Custom scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #dc2626;
            border-radius: 3px;
        }
        .sidebar {
            transition: all 0.3s ease;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
        }
    </style>
</head>
<body class="bg-white text-gray-900">
    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA-8qCiQbDjgIJz8cJHjbo5dajOm70QKpU",
            authDomain: "bonus-cms.firebaseapp.com",
            projectId: "bonus-cms",
            storageBucket: "bonus-cms.firebasestorage.app",
            messagingSenderId: "217665267949",
            appId: "1:217665267949:web:6279faf663b954c60104e4",
            measurementId: "G-1LTR20E5RN"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>

    <!-- Authentication Views -->
    <div id="auth-views" class="min-h-screen flex items-center justify-center bg-gray-50">
        <!-- Login View -->
        <div id="login-view" class="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
            <h2 class="text-2xl font-bold text-center mb-6 text-red-600">BonusDrivingSchool</h2>
            <h3 class="text-xl font-semibold text-center mb-6">Admin Login</h3>
            <form id="login-form">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="login-email">
                        Email
                    </label>
                    <input id="login-email" type="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="login-password">
                        Password
                    </label>
                    <input id="login-password" type="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                        Sign In
                    </button>
                </div>
            </form>
            <p class="text-center text-gray-600 text-xs mt-4">
                Don't have an account? 
                <a href="#" id="show-register" class="text-red-600 font-bold">Register here</a>
            </p>
            <div id="login-error" class="mt-4 text-red-600 text-center hidden"></div>
        </div>

        <!-- Registration View -->
        <div id="register-view" class="bg-white p-8 rounded-lg shadow-md w-full max-w-md hidden">
            <h2 class="text-2xl font-bold text-center mb-6 text-red-600">BonusDrivingSchool</h2>
            <h3 class="text-xl font-semibold text-center mb-6">Admin Registration</h3>
            <form id="register-form">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="register-email">
                        Email
                    </label>
                    <input id="register-email" type="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="register-password">
                        Password
                    </label>
                    <input id="register-password" type="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                        Register
                    </button>
                </div>
            </form>
            <p class="text-center text-gray-600 text-xs mt-4">
                Already have an account? 
                <a href="#" id="show-login" class="text-red-600 font-bold">Sign in here</a>
            </p>
            <div id="register-error" class="mt-4 text-red-600 text-center hidden"></div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="hidden">
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-button" class="md:hidden fixed top-4 left-4 z-50 bg-red-600 text-white p-2 rounded">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>

        <!-- Sidebar Navigation -->
        <div class="sidebar fixed inset-y-0 left-0 z-40 w-64 bg-gray-900 text-white transform md:translate-x-0">
            <div class="flex items-center justify-center h-16 bg-red-600">
                <h1 class="text-xl font-bold">BonusDrivingSchool</h1>
            </div>
            <nav class="mt-8">
                <ul>
                    <li class="mb-2">
                        <a href="#" class="nav-link block py-2 px-4 hover:bg-gray-800" data-tab="dashboard">
                            <span class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                </svg>
                                Dashboard
                            </span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="#" class="nav-link block py-2 px-4 hover:bg-gray-800" data-tab="clients">
                            <span class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                </svg>
                                Client Management
                            </span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="#" class="nav-link block py-2 px-4 hover:bg-gray-800" data-tab="payments">
                            <span class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                                Payment Management
                            </span>
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="#" class="nav-link block py-2 px-4 hover:bg-gray-800" data-tab="import">
                            <span class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                </svg>
                                Excel Import
                            </span>
                        </a>
                    </li>
                    <li class="mt-8">
                        <a href="#" id="logout-button" class="block py-2 px-4 hover:bg-gray-800 text-red-400">
                            <span class="flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                </svg>
                                Logout
                            </span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="md:ml-64 min-h-screen">
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content p-6">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-red-600">
                        <h3 class="text-lg font-semibold text-gray-700">Total Clients</h3>
                        <p id="total-clients" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-red-600">
                        <h3 class="text-lg font-semibold text-gray-700">Active Clients</h3>
                        <p id="active-clients" class="text-3xl font-bold text-gray-900 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-red-600">
                        <h3 class="text-lg font-semibold text-gray-700">Total Revenue</h3>
                        <p id="total-revenue" class="text-3xl font-bold text-gray-900 mt-2">R 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-red-600">
                        <h3 class="text-lg font-semibold text-gray-700">Pending Payments</h3>
                        <p id="pending-payments" class="text-3xl font-bold text-gray-900 mt-2">R 0</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Recent Clients</h3>
                        <div id="recent-clients" class="overflow-y-auto max-h-80">
                            <!-- Recent clients will be populated here -->
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Recent Payments</h3>
                        <div id="recent-payments" class="overflow-y-auto max-h-80">
                            <!-- Recent payments will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Client Management Tab -->
            <div id="clients-tab" class="tab-content p-6 hidden">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Client Management</h2>
                
                <!-- Client Form -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800" id="client-form-title">Add New Client</h3>
                    <form id="client-form">
                        <input type="hidden" id="client-id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-name">
                                    Name *
                                </label>
                                <input id="client-name" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-surname">
                                    Surname *
                                </label>
                                <input id="client-surname" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-email">
                                    Email Address
                                </label>
                                <input id="client-email" type="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-phone">
                                    Phone Number *
                                </label>
                                <input id="client-phone" type="tel" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-mom-phone">
                                    Mom's Number
                                </label>
                                <input id="client-mom-phone" type="tel" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-dad-phone">
                                    Dad's Number
                                </label>
                                <input id="client-dad-phone" type="tel" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-id-number">
                                    ID Number
                                </label>
                                <input id="client-id-number" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-status">
                                    Status
                                </label>
                                <select id="client-status" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-learners-code">
                                    Learner's Code
                                </label>
                                <select id="client-learners-code" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="client-license-code">
                                    License Code
                                </label>
                                <select id="client-license-code" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="EB">EB</option>
                                    <option value="C">C</option>
                                    <option value="EC">EC</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button type="button" id="cancel-client" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2">
                                Cancel
                            </button>
                            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                                Save Client
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Client Search -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Search Clients</h3>
                    <div class="flex flex-col md:flex-row gap-4">
                        <input id="client-search" type="text" placeholder="Search by name, email, phone, or ID..." class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <button id="search-clients" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded whitespace-nowrap">
                            Search
                        </button>
                        <button id="clear-search" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded whitespace-nowrap">
                            Clear
                        </button>
                    </div>
                </div>

                <!-- Client List -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Client List</h3>
                    <div id="client-list" class="overflow-x-auto">
                        <!-- Client list will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Payment Management Tab -->
            <div id="payments-tab" class="tab-content p-6 hidden">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Payment Management</h2>
                
                <!-- Payment Form -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800" id="payment-form-title">Add New Payment</h3>
                    <form id="payment-form">
                        <input type="hidden" id="payment-id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="payment-client">
                                    Client *
                                </label>
                                <select id="payment-client" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                                    <option value="">Select a client</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="payment-date">
                                    Payment Date *
                                </label>
                                <input id="payment-date" type="date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="payment-amount">
                                    Amount Paid *
                                </label>
                                <input id="payment-amount" type="number" step="0.01" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="payment-method">
                                    Payment Method *
                                </label>
                                <select id="payment-method" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                                    <option value="Cash">Cash</option>
                                    <option value="EFT">EFT</option>
                                    <option value="Card">Card</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button type="button" id="cancel-payment" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2">
                                Cancel
                            </button>
                            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                                Save Payment
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Financial Summary -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Financial Summary</h3>
                    <div id="financial-summary" class="overflow-x-auto">
                        <!-- Financial summary will be populated here -->
                    </div>
                </div>

                <!-- All Payments List -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">All Payments</h3>
                    <div id="payment-list" class="overflow-x-auto">
                        <!-- Payment list will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Excel Import Tab -->
            <div id="import-tab" class="tab-content p-6 hidden">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Excel Import Utility</h2>
                
                <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Import Data</h3>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="import-type">
                            Import Type
                        </label>
                        <select id="import-type" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                            <option value="clients">Client Records</option>
                            <option value="payments">Payment Records</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="excel-file">
                            Excel File (.xlsx, .xls)
                        </label>
                        <input id="excel-file" type="file" accept=".xlsx, .xls" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div class="flex justify-end">
                        <button id="import-data" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                            Import Data
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Import Results</h3>
                    <div id="import-results" class="overflow-x-auto">
                        <!-- Import results will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Detail Modal -->
    <div id="client-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800">Client Details</h3>
                    <button id="close-client-modal" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="client-detail-content">
                    <!-- Client details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let currentUser = null;
        let clients = [];
        let payments = [];
        let editingClientId = null;
        let editingPaymentId = null;

        // DOM Elements
        const authViews = document.getElementById('auth-views');
        const mainApp = document.getElementById('main-app');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegister = document.getElementById('show-register');
        const showLogin = document.getElementById('show-login');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');
        const logoutButton = document.getElementById('logout-button');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const sidebar = document.querySelector('.sidebar');
        const navLinks = document.querySelectorAll('.nav-link');
        const tabContents = document.querySelectorAll('.tab-content');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date for payment form
            document.getElementById('payment-date').valueAsDate = new Date();
            
            // Authentication state observer
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    authViews.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    loadData();
                } else {
                    currentUser = null;
                    authViews.classList.remove('hidden');
                    mainApp.classList.add('hidden');
                    showLoginView();
                }
            });

            // Event listeners for authentication
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            showRegister.addEventListener('click', showRegisterView);
            showLogin.addEventListener('click', showLoginView);
            logoutButton.addEventListener('click', handleLogout);

            // Event listeners for navigation
            mobileMenuButton.addEventListener('click', toggleMobileMenu);
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tab = this.getAttribute('data-tab');
                    showTab(tab);
                    if (window.innerWidth < 768) {
                        sidebar.classList.remove('active');
                    }
                });
            });

            // Event listeners for client management
            document.getElementById('client-form').addEventListener('submit', handleClientSubmit);
            document.getElementById('cancel-client').addEventListener('click', resetClientForm);
            document.getElementById('search-clients').addEventListener('click', searchClients);
            document.getElementById('clear-search').addEventListener('click', clearSearch);

            // Event listeners for payment management
            document.getElementById('payment-form').addEventListener('submit', handlePaymentSubmit);
            document.getElementById('cancel-payment').addEventListener('click', resetPaymentForm);

            // Event listeners for import
            document.getElementById('import-data').addEventListener('click', handleImport);

            // Event listener for client detail modal
            document.getElementById('close-client-modal').addEventListener('click', closeClientModal);

            // Initialize with dashboard tab
            showTab('dashboard');
        });

        // Authentication functions
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    // Login successful, handled by auth state observer
                })
                .catch(error => {
                    loginError.textContent = error.message;
                    loginError.classList.remove('hidden');
                });
        }

        function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;

            auth.createUserWithEmailAndPassword(email, password)
                .then(() => {
                    // Registration successful, handled by auth state observer
                })
                .catch(error => {
                    registerError.textContent = error.message;
                    registerError.classList.remove('hidden');
                });
        }

        function showLoginView() {
            loginView.classList.remove('hidden');
            registerView.classList.add('hidden');
            loginError.classList.add('hidden');
        }

        function showRegisterView() {
            loginView.classList.add('hidden');
            registerView.classList.remove('hidden');
            registerError.classList.add('hidden');
        }

        function handleLogout() {
            auth.signOut();
        }

        // Navigation functions
        function toggleMobileMenu() {
            sidebar.classList.toggle('active');
        }

        function showTab(tabName) {
            // Hide all tab contents
            tabContents.forEach(tab => {
                tab.classList.add('hidden');
            });

            // Remove active class from all nav links
            navLinks.forEach(link => {
                link.classList.remove('bg-gray-800');
            });

            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');

            // Add active class to selected nav link
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('bg-gray-800');

            // Load specific data if needed
            if (tabName === 'payments') {
                loadClientsForPaymentForm();
            }
        }

        // Data management functions
        function loadData() {
            loadClients();
            loadPayments();
        }

        function loadClients() {
            db.collection('clients').orderBy('registrationDate', 'desc')
                .onSnapshot(snapshot => {
                    clients = [];
                    snapshot.forEach(doc => {
                        clients.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    updateClientList();
                    updateDashboard();
                });
        }

        function loadPayments() {
            db.collection('payments').orderBy('date', 'desc')
                .onSnapshot(snapshot => {
                    payments = [];
                    snapshot.forEach(doc => {
                        payments.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    updatePaymentList();
                    updateFinancialSummary();
                    updateDashboard();
                });
        }

        function loadClientsForPaymentForm() {
            const paymentClientSelect = document.getElementById('payment-client');
            paymentClientSelect.innerHTML = '<option value="">Select a client</option>';
            
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.name} ${client.surname}`;
                paymentClientSelect.appendChild(option);
            });
        }

        // Client management functions
        function handleClientSubmit(e) {
            e.preventDefault();
            
            const clientData = {
                name: document.getElementById('client-name').value,
                surname: document.getElementById('client-surname').value,
                email: document.getElementById('client-email').value,
                phone: document.getElementById('client-phone').value,
                momPhone: document.getElementById('client-mom-phone').value,
                dadPhone: document.getElementById('client-dad-phone').value,
                idNumber: document.getElementById('client-id-number').value,
                status: document.getElementById('client-status').value,
                learnersCode: document.getElementById('client-learners-code').value,
                licenseCode: document.getElementById('client-license-code').value
            };

            if (editingClientId) {
                // Update existing client
                db.collection('clients').doc(editingClientId).update(clientData)
                    .then(() => {
                        resetClientForm();
                    })
                    .catch(error => {
                        console.error('Error updating client: ', error);
                    });
            } else {
                // Add new client
                clientData.registrationDate = firebase.firestore.FieldValue.serverTimestamp();
                
                db.collection('clients').add(clientData)
                    .then(() => {
                        resetClientForm();
                    })
                    .catch(error => {
                        console.error('Error adding client: ', error);
                    });
            }
        }

        function resetClientForm() {
            document.getElementById('client-form').reset();
            document.getElementById('client-id').value = '';
            document.getElementById('client-form-title').textContent = 'Add New Client';
            editingClientId = null;
        }

        function editClient(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (client) {
                document.getElementById('client-id').value = client.id;
                document.getElementById('client-name').value = client.name || '';
                document.getElementById('client-surname').value = client.surname || '';
                document.getElementById('client-email').value = client.email || '';
                document.getElementById('client-phone').value = client.phone || '';
                document.getElementById('client-mom-phone').value = client.momPhone || '';
                document.getElementById('client-dad-phone').value = client.dadPhone || '';
                document.getElementById('client-id-number').value = client.idNumber || '';
                document.getElementById('client-status').value = client.status || 'Active';
                document.getElementById('client-learners-code').value = client.learnersCode || '1';
                document.getElementById('client-license-code').value = client.licenseCode || 'B';
                
                document.getElementById('client-form-title').textContent = 'Edit Client';
                editingClientId = clientId;
                
                // Scroll to form
                document.getElementById('client-form').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteClient(clientId) {
            if (confirm('Are you sure you want to delete this client?')) {
                db.collection('clients').doc(clientId).delete()
                    .then(() => {
                        console.log('Client deleted successfully');
                    })
                    .catch(error => {
                        console.error('Error deleting client: ', error);
                    });
            }
        }

        function searchClients() {
            const searchTerm = document.getElementById('client-search').value.toLowerCase();
            if (!searchTerm) {
                updateClientList();
                return;
            }

            const filteredClients = clients.filter(client => 
                (client.name && client.name.toLowerCase().includes(searchTerm)) ||
                (client.surname && client.surname.toLowerCase().includes(searchTerm)) ||
                (client.email && client.email.toLowerCase().includes(searchTerm)) ||
                (client.phone && client.phone.includes(searchTerm)) ||
                (client.idNumber && client.idNumber.includes(searchTerm))
            );

            updateClientList(filteredClients);
        }

        function clearSearch() {
            document.getElementById('client-search').value = '';
            updateClientList();
        }

        function updateClientList(clientsToShow = clients) {
            const clientList = document.getElementById('client-list');
            
            if (clientsToShow.length === 0) {
                clientList.innerHTML = '<p class="text-center py-4">No clients found</p>';
                return;
            }

            let html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Registration</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            clientsToShow.forEach(client => {
                const registrationDate = client.registrationDate ? 
                    new Date(client.registrationDate.seconds * 1000).toLocaleDateString() : 'N/A';
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${client.name} ${client.surname}</div>
                                    <div class="text-sm text-gray-500">ID: ${client.idNumber || 'N/A'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${client.phone || 'N/A'}</div>
                            <div class="text-sm text-gray-500">${client.email || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                ${client.status === 'Active' ? 'bg-green-100 text-green-800' : 
                                  client.status === 'Completed' ? 'bg-blue-100 text-blue-800' : 
                                  'bg-red-100 text-red-800'}">
                                ${client.status || 'Unknown'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${registrationDate}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-red-600 hover:text-red-900 mr-3 view-client" data-id="${client.id}">View</button>
                            <button class="text-indigo-600 hover:text-indigo-900 mr-3 edit-client" data-id="${client.id}">Edit</button>
                            <button class="text-red-600 hover:text-red-900 delete-client" data-id="${client.id}">Delete</button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;

            clientList.innerHTML = html;

            // Add event listeners to the buttons
            document.querySelectorAll('.view-client').forEach(button => {
                button.addEventListener('click', function() {
                    showClientDetail(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.edit-client').forEach(button => {
                button.addEventListener('click', function() {
                    editClient(this.getAttribute('data-id'));
                });
            });

            document.querySelectorAll('.delete-client').forEach(button => {
                button.addEventListener('click', function() {
                    deleteClient(this.getAttribute('data-id'));
                });
            });
        }

        function showClientDetail(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            const clientPayments = payments.filter(p => p.clientId === clientId);
            const totalPaid = clientPayments.reduce((sum, payment) => sum + parseFloat(payment.amount || 0), 0);
            const courseFee = client.courseFee || 0;
            const balanceDue = courseFee - totalPaid;

            let html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h4 class="text-lg font-semibold mb-2 text-gray-800">Personal Information</h4>
                        <div class="bg-gray-50 p-4 rounded">
                            <p><strong>Name:</strong> ${client.name} ${client.surname}</p>
                            <p><strong>Email:</strong> ${client.email || 'N/A'}</p>
                            <p><strong>Phone:</strong> ${client.phone || 'N/A'}</p>
                            <p><strong>ID Number:</strong> ${client.idNumber || 'N/A'}</p>
                            <p><strong>Mom's Number:</strong> ${client.momPhone || 'N/A'}</p>
                            <p><strong>Dad's Number:</strong> ${client.dadPhone || 'N/A'}</p>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold mb-2 text-gray-800">Course Information</h4>
                        <div class="bg-gray-50 p-4 rounded">
                            <p><strong>Status:</strong> ${client.status || 'N/A'}</p>
                            <p><strong>Learner's Code:</strong> ${client.learnersCode || 'N/A'}</p>
                            <p><strong>License Code:</strong> ${client.licenseCode || 'N/A'}</p>
                            <p><strong>Registration Date:</strong> ${client.registrationDate ? 
                                new Date(client.registrationDate.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
                        </div>
                    </div>
                </div>
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-2 text-gray-800">Financial Summary</h4>
                    <div class="bg-gray-50 p-4 rounded grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <p><strong>Total Course Fee:</strong> R ${courseFee.toFixed(2)}</p>
                        </div>
                        <div>
                            <p><strong>Total Amount Paid:</strong> R ${totalPaid.toFixed(2)}</p>
                        </div>
                        <div>
                            <p><strong>Remaining Balance:</strong> R ${balanceDue.toFixed(2)}</p>
                        </div>
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-2 text-gray-800">Payment History</h4>
            `;

            if (clientPayments.length > 0) {
                html += `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;

                clientPayments.forEach(payment => {
                    const paymentDate = payment.date ? 
                        new Date(payment.date.seconds * 1000).toLocaleDateString() : 'N/A';
                    
                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${paymentDate}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">R ${parseFloat(payment.amount).toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${payment.method}</td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div>`;
            } else {
                html += '<p class="text-center py-4">No payment history found</p>';
            }

            html += `
                </div>
                <div class="mt-6 flex justify-end">
                    <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded edit-client-detail" data-id="${client.id}">
                        Edit Client
                    </button>
                </div>
            `;

            document.getElementById('client-detail-content').innerHTML = html;
            document.getElementById('client-detail-modal').classList.remove('hidden');

            // Add event listener to the edit button in the modal
            document.querySelector('.edit-client-detail').addEventListener('click', function() {
                closeClientModal();
                editClient(this.getAttribute('data-id'));
            });
        }

        function closeClientModal() {
            document.getElementById('client-detail-modal').classList.add('hidden');
        }

        // Payment management functions
        function handlePaymentSubmit(e) {
            e.preventDefault();
            
            const paymentData = {
                clientId: document.getElementById('payment-client').value,
                date: new Date(document.getElementById('payment-date').value),
                amount: parseFloat(document.getElementById('payment-amount').value),
                method: document.getElementById('payment-method').value
            };

            if (editingPaymentId) {
                // Update existing payment
                db.collection('payments').doc(editingPaymentId).update(paymentData)
                    .then(() => {
                        resetPaymentForm();
                    })
                    .catch(error => {
                        console.error('Error updating payment: ', error);
                    });
            } else {
                // Add new payment
                db.collection('payments').add(paymentData)
                    .then(() => {
                        resetPaymentForm();
                    })
                    .catch(error => {
                        console.error('Error adding payment: ', error);
                    });
            }
        }

        function resetPaymentForm() {
            document.getElementById('payment-form').reset();
            document.getElementById('payment-id').value = '';
            document.getElementById('payment-date').valueAsDate = new Date();
            document.getElementById('payment-form-title').textContent = 'Add New Payment';
            editingPaymentId = null;
        }

        function updatePaymentList() {
            const paymentList = document.getElementById('payment-list');
            
            if (payments.length === 0) {
                paymentList.innerHTML = '<p class="text-center py-4">No payments found</p>';
                return;
            }

            let html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            payments.forEach(payment => {
                const client = clients.find(c => c.id === payment.clientId);
                const clientName = client ? `${client.name} ${client.surname}` : 'Unknown Client';
                const paymentDate = payment.date ? 
                    new Date(payment.date.seconds * 1000).toLocaleDateString() : 'N/A';
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${clientName}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${paymentDate}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            R ${parseFloat(payment.amount).toFixed(2)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${payment.method}
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;

            paymentList.innerHTML = html;
        }

        function updateFinancialSummary() {
            const financialSummary = document.getElementById('financial-summary');
            
            if (clients.length === 0) {
                financialSummary.innerHTML = '<p class="text-center py-4">No clients found</p>';
                return;
            }

            let html = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Course Fee</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Paid</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance Due</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            clients.forEach(client => {
                const clientPayments = payments.filter(p => p.clientId === client.id);
                const totalPaid = clientPayments.reduce((sum, payment) => sum + parseFloat(payment.amount || 0), 0);
                const courseFee = client.courseFee || 0;
                const balanceDue = courseFee - totalPaid;
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${client.name} ${client.surname}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            R ${courseFee.toFixed(2)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            R ${totalPaid.toFixed(2)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium 
                            ${balanceDue > 0 ? 'text-red-600' : 'text-green-600'}">
                            R ${balanceDue.toFixed(2)}
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;

            financialSummary.innerHTML = html;
        }

        // Dashboard functions
        function updateDashboard() {
            // Update client counts
            document.getElementById('total-clients').textContent = clients.length;
            const activeClients = clients.filter(client => client.status === 'Active').length;
            document.getElementById('active-clients').textContent = activeClients;

            // Update financial data
            const totalRevenue = payments.reduce((sum, payment) => sum + parseFloat(payment.amount || 0), 0);
            document.getElementById('total-revenue').textContent = `R ${totalRevenue.toFixed(2)}`;
            
            // Calculate pending payments (this would need course fee data which we don't have)
            // For now, we'll just show 0
            document.getElementById('pending-payments').textContent = 'R 0.00';

            // Update recent clients
            updateRecentClients();
            
            // Update recent payments
            updateRecentPayments();
        }

        function updateRecentClients() {
            const recentClients = document.getElementById('recent-clients');
            const recent = clients.slice(0, 5); // Get 5 most recent clients
            
            if (recent.length === 0) {
                recentClients.innerHTML = '<p class="text-center py-4">No clients found</p>';
                return;
            }

            let html = '';
            recent.forEach(client => {
                const registrationDate = client.registrationDate ? 
                    new Date(client.registrationDate.seconds * 1000).toLocaleDateString() : 'N/A';
                
                html += `
                    <div class="border-b border-gray-200 py-3">
                        <div class="flex justify-between">
                            <div>
                                <p class="font-medium">${client.name} ${client.surname}</p>
                                <p class="text-sm text-gray-500">${client.phone || 'No phone'}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-500">${registrationDate}</p>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                    ${client.status === 'Active' ? 'bg-green-100 text-green-800' : 
                                      client.status === 'Completed' ? 'bg-blue-100 text-blue-800' : 
                                      'bg-red-100 text-red-800'}">
                                    ${client.status || 'Unknown'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });

            recentClients.innerHTML = html;
        }

        function updateRecentPayments() {
            const recentPayments = document.getElementById('recent-payments');
            const recent = payments.slice(0, 5); // Get 5 most recent payments
            
            if (recent.length === 0) {
                recentPayments.innerHTML = '<p class="text-center py-4">No payments found</p>';
                return;
            }

            let html = '';
            recent.forEach(payment => {
                const client = clients.find(c => c.id === payment.clientId);
                const clientName = client ? `${client.name} ${client.surname}` : 'Unknown Client';
                const paymentDate = payment.date ? 
                    new Date(payment.date.seconds * 1000).toLocaleDateString() : 'N/A';
                
                html += `
                    <div class="border-b border-gray-200 py-3">
                        <div class="flex justify-between">
                            <div>
                                <p class="font-medium">${clientName}</p>
                                <p class="text-sm text-gray-500">${payment.method}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-medium">R ${parseFloat(payment.amount).toFixed(2)}</p>
                                <p class="text-sm text-gray-500">${paymentDate}</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            recentPayments.innerHTML = html;
        }

        // Import functions
        function handleImport() {
            const importType = document.getElementById('import-type').value;
            const fileInput = document.getElementById('excel-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select an Excel file to import.');
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Get the first worksheet
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                if (importType === 'clients') {
                    importClients(jsonData);
                } else if (importType === 'payments') {
                    importPayments(jsonData);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function importClients(data) {
            let results = {
                success: 0,
                errors: 0,
                details: []
            };

            // Process each row
            data.forEach((row, index) => {
                try {
                    // Map Excel columns to client fields
                    const clientData = {
                        name: row['Name'] || row['name'] || '',
                        surname: row['Surname'] || row['surname'] || '',
                        email: row['Email'] || row['email'] || '',
                        phone: row['Phone'] || row['phone'] || '',
                        momPhone: row['Mom Phone'] || row['mom_phone'] || row['momPhone'] || '',
                        dadPhone: row['Dad Phone'] || row['dad_phone'] || row['dadPhone'] || '',
                        idNumber: row['ID Number'] || row['id_number'] || row['idNumber'] || '',
                        status: row['Status'] || row['status'] || 'Active',
                        learnersCode: row['Learners Code'] || row['learners_code'] || row['learnersCode'] || '1',
                        licenseCode: row['License Code'] || row['license_code'] || row['licenseCode'] || 'B',
                        registrationDate: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    // Validate required fields
                    if (!clientData.name || !clientData.surname || !clientData.phone) {
                        throw new Error('Missing required fields (name, surname, phone)');
                    }

                    // Add to Firestore
                    db.collection('clients').add(clientData)
                        .then(() => {
                            results.success++;
                            results.details.push(`Row ${index + 1}: Successfully imported ${clientData.name} ${clientData.surname}`);
                            updateImportResults(results);
                        })
                        .catch(error => {
                            results.errors++;
                            results.details.push(`Row ${index + 1}: Error - ${error.message}`);
                            updateImportResults(results);
                        });

                } catch (error) {
                    results.errors++;
                    results.details.push(`Row ${index + 1}: Error - ${error.message}`);
                }
            });

            updateImportResults(results);
        }

        function importPayments(data) {
            let results = {
                success: 0,
                errors: 0,
                details: []
            };

            // Process each row
            data.forEach((row, index) => {
                try {
                    // Map Excel columns to payment fields
                    const clientIdentifier = row['Client ID'] || row['client_id'] || row['clientId'] || 
                                            row['Client Name'] || row['client_name'] || row['clientName'] || '';
                    
                    if (!clientIdentifier) {
                        throw new Error('Missing client identifier');
                    }

                    // Find the client by ID or name
                    let client = null;
                    if (clientIdentifier.includes(' ')) {
                        // Assume it's a name
                        const [name, surname] = clientIdentifier.split(' ');
                        client = clients.find(c => 
                            c.name.toLowerCase() === name.toLowerCase() && 
                            c.surname.toLowerCase() === surname.toLowerCase()
                        );
                    } else {
                        // Assume it's an ID
                        client = clients.find(c => c.id === clientIdentifier);
                    }

                    if (!client) {
                        throw new Error(`Client not found: ${clientIdentifier}`);
                    }

                    const paymentData = {
                        clientId: client.id,
                        date: new Date(row['Date'] || row['date'] || new Date()),
                        amount: parseFloat(row['Amount'] || row['amount'] || 0),
                        method: row['Method'] || row['method'] || 'Cash'
                    };

                    // Validate required fields
                    if (!paymentData.amount || paymentData.amount <= 0) {
                        throw new Error('Invalid amount');
                    }

                    // Add to Firestore
                    db.collection('payments').add(paymentData)
                        .then(() => {
                            results.success++;
                            results.details.push(`Row ${index + 1}: Successfully imported payment for ${client.name} ${client.surname}`);
                            updateImportResults(results);
                        })
                        .catch(error => {
                            results.errors++;
                            results.details.push(`Row ${index + 1}: Error - ${error.message}`);
                            updateImportResults(results);
                        });

                } catch (error) {
                    results.errors++;
                    results.details.push(`Row ${index + 1}: Error - ${error.message}`);
                }
            });

            updateImportResults(results);
        }

        function updateImportResults(results) {
            const importResults = document.getElementById('import-results');
            
            let html = `
                <div class="mb-4">
                    <p><strong>Import Summary:</strong> ${results.success} successful, ${results.errors} errors</p>
                </div>
            `;

            if (results.details.length > 0) {
                html += '<div class="max-h-60 overflow-y-auto border border-gray-200 rounded">';
                results.details.forEach(detail => {
                    const isError = detail.includes('Error');
                    html += `
                        <div class="p-2 border-b border-gray-200 ${isError ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}">
                            ${detail}
                        </div>
                    `;
                });
                html += '</div>';
            }

            importResults.innerHTML = html;
        }
    </script>
</body>
</html>